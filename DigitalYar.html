<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>دیجیتال‌یار - آزمون‌ساز هوشمند</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- اضافه کردن PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <style>
        /* فونت BNaznin */
        
        @font-face {
            font-family: "BNaznin";
            src: url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.eot");
            src: url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.eot?#iefix") format("embedded-opentype"), url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.woff2") format("woff2"), url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.woff") format("woff"), url("https://cdn.jsdelivr.net/gh/aminpoint/b-naznin@1.0.0/BNaznin.ttf") format("truetype");
            font-weight: normal;
            font-style: normal;
        }
        /* تم اقیانوس (پیش‌فرض) */
        
         :root {
            --primary-color: #006994;
            --primary-light: #0088b2;
            --primary-dark: #005276;
            --secondary-color: #00b4d8;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --water-color: #e0f7ff;
            --water-light: #f0fbff;
            --water-dark: #b3e5fc;
            --text-color: #0a3d62;
            --text-muted: #4a6b8a;
            --border-color: #81d4fa;
            --card-bg: rgba(255, 255, 255, 0.92);
            --card-hover: rgba(255, 255, 255, 0.97);
            --header-bg: rgba(224, 247, 255, 0.92);
            --shadow: 0 8px 32px rgba(0, 105, 148, 0.18);
            --shadow-light: 0 4px 16px rgba(0, 105, 148, 0.12);
            --gradient-primary: linear-gradient( 135deg, var(--primary-color), var(--primary-dark));
            --gradient-water: linear-gradient( 135deg, var(--water-light), var(--water-color));
            --gradient-glass: linear-gradient( 135deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.45));
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --border-radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-family: "BNaznin", Vazirmatn, sans-serif;
        }
        /* تم ساحل (روشن) - بهبود یافته */
        
        [data-theme="beach"] {
            --primary-color: #ff7e5f;
            --primary-light: #ff9e80;
            --primary-dark: #e85c40;
            --secondary-color: #feb47b;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --water-color: #fff5e6;
            --water-light: #fffaf0;
            --water-dark: #ffe4c4;
            --text-color: #5d4037;
            --text-muted: #8d6e63;
            --border-color: #ffccbc;
            --card-bg: rgba(255, 255, 255, 0.92);
            --card-hover: rgba(255, 255, 255, 0.97);
            --header-bg: rgba(255, 245, 230, 0.92);
            --shadow: 0 8px 32px rgba(255, 126, 95, 0.2);
            --shadow-light: 0 4px 16px rgba(255, 126, 95, 0.15);
            --gradient-primary: linear-gradient( 135deg, var(--primary-color), var(--primary-dark));
            --gradient-water: linear-gradient( 135deg, var(--water-light), var(--water-color));
            --gradient-glass: linear-gradient( 135deg, rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0.45));
        }
        /* تم کهکشان (تاریک) - بهبود یافته */
        
        [data-theme="galaxy"] {
            --primary-color: #8a2be2;
            --primary-light: #9370db;
            --primary-dark: #4b0082;
            --secondary-color: #00bfff;
            --success-color: #00fa9a;
            --warning-color: #ffd700;
            --danger-color: #ff4500;
            --water-color: #0c0032;
            --water-light: #190061;
            --water-dark: #04000f;
            --text-color: #e6e6fa;
            --text-muted: #a9a9a9;
            --border-color: #483d8b;
            --card-bg: rgba(25, 0, 97, 0.88);
            --card-hover: rgba(40, 0, 130, 0.92);
            --header-bg: rgba(12, 0, 50, 0.92);
            --shadow: 0 8px 32px rgba(138, 43, 226, 0.25);
            --shadow-light: 0 4px 16px rgba(138, 43, 226, 0.2);
            --gradient-primary: linear-gradient( 135deg, var(--primary-color), var(--primary-dark));
            --gradient-water: linear-gradient( 135deg, var(--water-light), var(--water-color));
            --gradient-glass: linear-gradient( 135deg, rgba(25, 0, 97, 0.75), rgba(25, 0, 97, 0.45));
        }
        /* تم معدن زغال سنگ (تاریک) - بهبود یافته */
        
        [data-theme="coal-mine"] {
            --primary-color: #4ecdc4;
            --primary-light: #68d8d6;
            --primary-dark: #2a9d8f;
            --secondary-color: #f9c74f;
            --success-color: #90be6d;
            --warning-color: #f8961e;
            --danger-color: #f94144;
            --water-color: #1a1a1d;
            --water-light: #2d2d30;
            --water-dark: #0d0d0d;
            --text-color: #edf2f4;
            --text-muted: #8d99ae;
            --border-color: #4a4e69;
            --card-bg: rgba(45, 45, 48, 0.88);
            --card-hover: rgba(55, 55, 58, 0.92);
            --header-bg: rgba(26, 26, 29, 0.92);
            --shadow: 0 8px 32px rgba(78, 205, 196, 0.25);
            --shadow-light: 0 4px 16px rgba(78, 205, 196, 0.2);
            --gradient-primary: linear-gradient( 135deg, var(--primary-color), var(--primary-dark));
            --gradient-water: linear-gradient( 135deg, var(--water-light), var(--water-color));
            --gradient-glass: linear-gradient( 135deg, rgba(45, 45, 48, 0.75), rgba(45, 45, 48, 0.45));
        }
        /* ریست استایل‌ها */
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
        }
        
        body {
            background: var(--gradient-water);
            color: var(--text-color);
            line-height: 1.6;
            transition: var(--transition-slow);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            overflow-x: hidden;
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transform: translateZ(0);
            margin-top: 20px;
            margin-bottom: 20px;
        }
        /* هدر */
        
        .header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .logo i {
            font-size: 2.2rem;
            color: var(--primary-color);
            transition: var(--transition);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        
        .logo:hover i {
            transform: rotate(-15deg);
        }
        /* کنترل‌های هدر */
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .theme-selector {
            display: flex;
            gap: 8px;
            background: var(--gradient-glass);
            padding: 8px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .theme-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: var(--transition);
            border-radius: 50%;
        }
        
        .theme-btn.active,
        .theme-btn:hover {
            color: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-light);
        }
        
        .theme-btn.active::before,
        .theme-btn:hover::before {
            opacity: 1;
        }
        
        .theme-btn i {
            position: relative;
            z-index: 1;
        }
        
        /* دکمه بازگشت */
        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-family: "Vazirmatn", sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }
        
        .back-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            opacity: 0;
            transition: var(--transition);
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .back-btn:hover::before {
            opacity: 1;
        }
        
        .back-btn i {
            position: relative;
            z-index: 1;
            transition: var(--transition);
        }
        
        .back-btn:hover i {
            transform: translateX(3px);
        }
        
        .main-content {
            padding: 30px;
        }
        
        .page {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        
        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .form-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .form-container h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-container p {
            color: var(--text-muted);
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 105, 148, 0.3);
        }
        
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #6c757d 0%, #495057 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient( 90deg, var(--success-color) 0%, #27ae60 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
            font-size: 0.9rem;
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: "BNaznin", "Vazirmatn", monospace;
            resize: vertical;
            min-height: 120px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .input-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 105, 148, 0.3);
        }
        /* استایل‌های جدید برای آپلود فایل */
        
        .file-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: rgba(0, 105, 148, 0.05);
        }
        
        .file-upload-container:hover {
            border-color: var(--primary-color);
            background: rgba(0, 105, 148, 0.1);
        }
        
        .file-upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .file-upload-text h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .file-upload-text p {
            color: var(--text-muted);
            margin-bottom: 15px;
        }
        
        .file-formats {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .format-badge {
            padding: 5px 10px;
            background: var(--primary-light);
            color: white;
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
        }
        
        .upload-preview {
            margin-top: 20px;
            max-width: 100%;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            display: none;
        }
        /* استایل‌های جدید برای کارت‌های گزینه */
        
        .options-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .option-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .option-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-light);
            border-color: var(--primary-light);
        }
        
        .option-card.selected {
            border-color: var(--primary-color);
            background: rgba(0, 105, 148, 0.1);
            transform: translateY(-5px);
            box-shadow: var(--shadow-light);
        }
        
        .option-card h3 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .option-card p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        /* استایل‌های جدید برای تایمر */
        
        .timer-input-simple {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timer-input-simple input {
            max-width: 120px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .timer-input-simple span {
            font-weight: bold;
            color: var(--primary-color);
        }
        /* استایل‌های جدید برای پرامپت‌ها */
        
        .prompt-section {
            background: rgba(0, 105, 148, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        
        .prompt-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .prompt-btn {
            padding: 10px 15px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .prompt-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .copy-btn {
            position: absolute;
            left: 15px;
            top: 40px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .copy-btn:hover {
            background: var(--primary-color);
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        /* استایل‌های جدید برای بخش کلید آزمون */
        
        .exam-key-section {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background: var(--card-bg);
        }
        
        .exam-key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .exam-key-header h4 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .exam-key-input {
            width: 100%;
            padding: 12px 15px 12px 50px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--text-color);
            min-height: 120px;
            resize: vertical;
        }
        
        .paste-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 2;
        }
        
        .paste-btn:hover {
            background: var(--primary-color);
        }
        /* استایل‌های صفحه آزمون */
        
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .exam-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        
        .timer-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .timer {
            font-size: 1.8rem;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            background: rgba(0, 105, 148, 0.1);
            color: var(--primary-color);
            position: relative;
            overflow: hidden;
        }
        
        .timer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient( 45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }
        
        .timer:hover::before {
            transform: translateX(100%);
        }
        
        .timer.hidden {
            filter: blur(5px);
        }
        
        .toggle-timer {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        /* نوار وضعیت سوالات */
        
        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .progress-item {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--border-color);
            color: var(--text-muted);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        
        .progress-item.active {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .progress-item.answered {
            background: var(--success-color);
            color: white;
        }
        
        .progress-item.current {
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .questions-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .question-card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            background: var(--card-bg);
            transition: var(--transition);
            position: relative;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }
        
        .question-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .question-number {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .question-image {
            width: 100%;
            margin-bottom: 15px;
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-light);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .question-image:hover {
            transform: scale(1.02);
        }
        
        .options-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .option-item:hover {
            background: rgba(0, 105, 148, 0.1);
        }
        
        .option-item.selected {
            background: rgba(46, 204, 113, 0.2);
            border-color: var(--success-color);
        }
        
        .option-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .option-item.selected .option-marker {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .exam-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        /* صفحه‌بندی بهبود یافته */
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 20px;
        }
        
        .page-btn {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn:hover:not(.active) {
            background: rgba(0, 105, 148, 0.1);
        }
        /* مودال‌های جدید */
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow);
            animation: scaleIn 0.3s ease;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        /* تغییر استایل container برای تمام‌صفحه */
        
        .container {
            max-width: 100%;
            margin: 0;
            border-radius: 0;
            min-height: 100vh;
        }
        
        .main-content {
            padding: 20px;
        }
        /* برای صفحه‌های دیگر حالت عادی */
        
        .page:not(#manual-exam) .container {
            max-width: 1000px;
            margin: 20px auto;
            border-radius: var(--border-radius-lg);
        }
        /* راهنمای آزمون */
        
        .guide-container {
            background: rgba(0, 105, 148, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary-color);
        }
        
        .guide-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .guide-steps {
            margin-right: 20px;
        }
        
        .guide-steps li {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .warning-box {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning-color);
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-top: 15px;
        }
        
        .warning-box h4 {
            color: var(--warning-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* صفحه نتایج */
        
        .result-page {
            text-align: center;
            padding: 40px 20px;
        }
        
        .result-page h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .result-page p {
            color: var(--text-muted);
            margin-bottom: 30px;
        }
        /* استایل‌های آکاردئون */
        
        .accordion-section {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .accordion-header {
            background: var(--header-bg);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        .accordion-header:hover {
            background: rgba(0, 105, 148, 0.1);
        }
        
        .accordion-header h2 {
            margin: 0;
            font-size: 1.3rem;
            color: var(--primary-color);
        }
        
        .accordion-icon {
            transition: var(--transition);
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .accordion-section.active .accordion-content {
            max-height: 1000px;
        }
        
        .accordion-section.active .accordion-icon {
            transform: rotate(180deg);
        }
        /* استایل‌های جدید برای هدر کلید آزمون */
        
        .exam-key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .exam-key-header h4 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .copy-exam-key-btn {
            padding: 8px 15px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .copy-exam-key-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        /* استایل برای تذکر مهم */
        
        .important-notice {
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid var(--warning-color);
            border-radius: var(--border-radius-sm);
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .important-notice i {
            color: var(--warning-color);
        }
        /* استایل دکمه پیست */
        
        .paste-btn {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 2;
        }
        
        .paste-btn:hover {
            background: var(--primary-color);
        }
        /* بهبود استایل‌های کارت‌های راهنما */
        
        .guide-steps-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .guide-step-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }
        
        .guide-step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .step-title {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .step-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        /* رسپانسیو برای موبایل */
        
        @media (max-width: 768px) {
            .guide-steps-grid {
                grid-template-columns: 1fr;
            }
            .exam-key-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
        /* استایل‌های جدید برای صفحه آزمون نوع 1 - فول‌اسکرین بهبود یافته */
        
        .type1-exam-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--card-bg);
            z-index: 10000;
            display: grid;
            grid-template-columns: 1fr 400px;
            /* سمت چپ برای PDF، سمت راست برای سوالات */
            gap: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .type1-exam-fullscreen .pdf-viewer-container {
            background: var(--water-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .type1-exam-fullscreen .pdf-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            z-index: 10;
        }
        
        .type1-exam-fullscreen .pdf-page-image {
            width: 100%;
            height: calc(100vh - 150px);
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: zoom-in;
            transition: transform 0.3s ease;
            background: white;
        }
        
        .type1-exam-fullscreen .pdf-page-image:hover {
            transform: scale(1.01);
        }
        
        .type1-exam-fullscreen .questions-sidebar {
            background: var(--card-bg);
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            border-left: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        /* استایل‌های جدید برای سوالات ستونی */
        
        .questions-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }
        
        .question-item-column {
            background: var(--water-light);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            transition: var(--transition);
        }
        
        .question-item-column:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .question-item-column.active {
            border-color: var(--primary-color);
            background: rgba(0, 105, 148, 0.1);
        }
        
        .question-item-column.answered {
            border-color: var(--success-color);
            background: rgba(46, 204, 113, 0.1);
        }
        
        .question-header-column {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .question-number-column {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .question-status-column {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        /* استایل‌های جدید برای گزینه‌های افقی مربعی */
        
        .options-horizontal {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .option-square-small {
            width: 35px;
            height: 35px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .option-square-small:hover {
            background: rgba(0, 105, 148, 0.1);
            transform: translateY(-2px);
        }
        
        .option-square-small.selected {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
            transform: scale(1.05);
        }
        /* استایل‌های جدید برای هدر بهبود یافته */
        
        .sidebar-header-improved {
            background: var(--card-bg);
            padding: 15px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .exam-info-top {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .header-timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 105, 148, 0.1);
            border-radius: var(--border-radius);
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .questions-header h4 {
            margin: 0;
            color: var(--primary-color);
        }
        
        .questions-count {
            background: var(--primary-color);
            color: white;
            padding: 5px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            font-weight: bold;
        }
        /* رسپانسیو برای موبایل */
        
        @media (max-width: 768px) {
            .type1-exam-fullscreen {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            .type1-exam-fullscreen .questions-sidebar {
                height: 40vh;
                border-left: none;
                border-top: 2px solid var(--border-color);
            }
            .exam-controls-fullscreen {
                right: 20px;
                bottom: 45vh;
                flex-direction: column;
            }
            .timer-fullscreen {
                right: 20px;
                top: 80px;
            }
        }
        /* استایل‌های جدید برای کارت‌های سوال بهبود یافته */
        
        .question-card-improved {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background: var(--card-bg);
            transition: var(--transition);
            position: relative;
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
        }
        
        .question-card-improved:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .question-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .question-options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .question-option {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .question-option:hover {
            background: rgba(0, 105, 148, 0.1);
        }
        
        .question-option.selected {
            background: rgba(46, 204, 113, 0.2);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        /* اضافه کردن این استایل‌ها */
        
        .exam-key-section {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .hidden-section {
            margin-bottom: 20px;
        }
        /* استایل برای آیکون پیست در فیلد کلید آزمون */
        
        .exam-key-section .copy-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 2;
        }
        
        .exam-key-section .copy-btn:hover {
            background: var(--primary-color);
        }
        /* استایل‌های جدید برای صفحه آزمون نوع 1 - فول‌اسکرین */
        
        .type1-exam-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--card-bg);
            z-index: 10000;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        .type1-exam-fullscreen .pdf-viewer-container {
            background: var(--water-light);
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .type1-exam-fullscreen .pdf-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }
        
        .type1-exam-fullscreen .pdf-page-image {
            width: 100%;
            height: calc(100vh - 150px);
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: zoom-in;
            transition: transform 0.3s ease;
            background: white;
        }
        
        .type1-exam-fullscreen .pdf-page-image:hover {
            transform: scale(1.01);
        }
        
        .type1-exam-fullscreen .questions-sidebar {
            background: var(--card-bg);
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            border-left: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .type1-exam-fullscreen .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 10;
        }
        
        .type1-exam-fullscreen .questions-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
        }
        
        .type1-exam-fullscreen .question-item {
            background: var(--water-light);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 10px;
        }
        
        .type1-exam-fullscreen .question-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }
        
        .type1-exam-fullscreen .question-item.active {
            border-color: var(--primary-color);
            background: rgba(0, 105, 148, 0.1);
        }
        
        .type1-exam-fullscreen .question-item.answered {
            border-color: var(--success-color);
            background: rgba(46, 204, 113, 0.1);
        }
        
        .type1-exam-fullscreen .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .type1-exam-fullscreen .question-number {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .type1-exam-fullscreen .question-options-vertical {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .type1-exam-fullscreen .option-item-vertical {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
        }
        
        .type1-exam-fullscreen .option-item-vertical:hover {
            background: rgba(0, 105, 148, 0.05);
        }
        
        .type1-exam-fullscreen .option-item-vertical.selected {
            background: rgba(46, 204, 113, 0.2);
            border-color: var(--success-color);
        }
        
        .type1-exam-fullscreen .option-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: var(--card-bg);
        }
        
        .type1-exam-fullscreen .option-item-vertical.selected .option-marker {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .type1-exam-fullscreen .exam-controls {
            position: fixed;
            bottom: 20px;
            right: 370px;
            z-index: 10001;
            display: flex;
            gap: 10px;
        }
        /* رسپانسیو برای موبایل */
        
        @media (max-width: 768px) {
            .type1-exam-fullscreen {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            .type1-exam-fullscreen .questions-sidebar {
                height: 40vh;
                border-left: none;
                border-top: 2px solid var(--border-color);
            }
            .type1-exam-fullscreen .exam-controls {
                right: 20px;
                bottom: 45vh;
                flex-direction: column;
            }
        }
        /* استایل برای دکمه‌های پیست */
        
        .prompt-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .prompt-btn {
            padding: 10px 15px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .prompt-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        /* رسپانسیو برای موبایل */
        
        @media (max-width: 768px) {
            .prompt-buttons {
                flex-direction: column;
            }
            .prompt-btn {
                justify-content: center;
            }
        }
        /* استایل‌های جدید برای کادر کپی کلید آزمون */
        
        .copy-key-container {
            margin-bottom: 20px;
        }
        
        .copy-key-box {
            background: var(--gradient-primary);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
        }
        
        .copy-key-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .copy-key-box i {
            font-size: 1.2rem;
        }
        
        .copy-key-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-align: center;
            margin: 0;
        }
        /* استایل‌های جدید برای بخش برش سوالات */
        
        .question-slicing-section {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background: var(--card-bg);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .toggle-slicing-btn {
            padding: 8px 15px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .toggle-slicing-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .section-content {
            transition: all 0.3s ease;
        }
        /* استایل‌های جدید برای دکمه‌ها */
        
        .btn-warning {
            background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(90deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .timer-container-sidebar {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 105, 148, 0.1);
            border-radius: var(--border-radius);
        }
        
        .exam-actions-sidebar {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        /* اضافه کردن این استایل به بخش CSS */
        
        .exam-key-input {
            width: 100%;
            padding: 12px 15px 12px 50px;
            /* فضای بیشتر برای آیکون */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--text-color);
            margin-top: 10px;
            min-height: 120px;
            /* هم اندازه با فیلد JSON */
            resize: vertical;
        }
        /* استایل‌های بهبود یافته برای باکس سوالات - بدون انیمیشن‌های مشکل‌ساز */
        
        .question-box {
            padding: 12px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            box-shadow: var(--shadow-light);
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 5px;
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 70px;
            justify-content: center;
            align-items: center;
        }
        
        .question-box:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            z-index: 10;
        }
        
        .question-box.selected {
            border: 2px solid var(--primary-color);
            transform: scale(1.02);
        }
        
        .question-box.correct {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--success-color);
        }
        
        .question-box.wrong {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--danger-color);
        }
        
        .question-box.empty {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid var(--warning-color);
        }
        /* حذف انیمیشن‌های مشکل‌ساز */
        
        .question-box:hover {
            animation: none;
        }
        
        .stat-card:hover {
            animation: none;
        }
        
        .btn-primary {
            animation: none;
        }
        /* استایل‌های جدید برای راهنمای جامع */
        
        .comprehensive-guide {
            background: rgba(0, 105, 148, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .comprehensive-guide h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .guide-steps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .guide-step-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }
        
        .guide-step-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .step-title {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .step-description {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        /* اضافه کردن این استایل‌ها به بخش CSS */
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--card-bg);
            color: var(--text-color);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.5s ease, opacity 0.5s ease;
            opacity: 0;
            max-width: 90%;
            width: auto;
        }
        
        .notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            border-left-color: var(--success-color);
        }
        
        .notification.error {
            border-left-color: var(--danger-color);
        }
        
        .notification.warning {
            border-left-color: var(--warning-color);
        }
        
        .notification.info {
            border-left-color: var(--primary-color);
        }
        /* استایل‌های جدید برای صفحه نتایج بهبود یافته */
        
        .result-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }
        
        .result-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .result-score {
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 20px 0;
        }
        
        .result-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-detail-card {
            background: rgba(0, 105, 148, 0.05);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
        }
        
        .result-detail-card h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .result-detail-card p {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
        }
        /* انیمیشن‌ها */
        /* استایل‌های جدید برای زوم تصاویر */
        /* مودال زوم تصویر */
        
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
            cursor: zoom-out;
        }
        
        .image-zoom-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .zoomed-image-container {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .zoomed-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            cursor: default;
        }
        
        .image-zoom-modal.active .zoomed-image {
            transform: scale(1);
        }
        
        .close-zoom {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            z-index: 10002;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .close-zoom:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        /* اضافه کردن این استایل‌ها به بخش CSS */
        
        .timer-input-container {
            margin-bottom: 20px;
        }
        
        .timer-input-stretched {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .stretched-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--card-bg);
            color: var(--text-color);
            text-align: center;
        }
        
        .minute-label {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 60px;
        }
        /* جلوگیری از اسکرول هنگام نمایش مودال */
        
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        /* استایل‌های پایه برای container */
        
        .container {
            max-width: 100%;
            margin: 0;
            border-radius: 0;
            min-height: 100vh;
            transition: var(--transition-slow);
        }
        /* برای دسکتاپ و تبلت - با کادر */
        
        @media (min-width: 769px) {
            .container {
                max-width: 1000px;
                margin: 20px auto;
                border-radius: var(--border-radius-lg);
                box-shadow: var(--shadow);
                min-height: auto;
            }
            .main-content {
                padding: 30px;
            }
        }
        /* استایل‌های خاص برای موبایل */
        
        .mobile-view .container {
            background: var(--card-bg);
            min-height: 100vh;
        }
        
        .mobile-view .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }
        
        .mobile-view .main-content {
            padding-bottom: 80px;
            /* فضای برای footer */
        }
        /* استایل‌های خاص برای دسکتاپ */
        
        .desktop-view .container {
            background: var(--card-bg);
            animation: fadeInUp 0.8s ease;
        }
        /* انیمیشن برای ظاهر شدن کادر در دسکتاپ */
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* بهبود فونت‌ها برای دستگاه‌های مختلف */
        
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            .logo {
                font-size: 1.5rem;
            }
            .logo i {
                font-size: 1.8rem;
            }
        }
        
        @media (min-width: 769px) {
            body {
                font-size: 16px;
            }
        }
        /* برای موبایل - فول‌اسکرین */
        
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            .main-content {
                padding: 20px;
            }
            /* بهبود استایل‌های موبایل */
            .exam-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .timer-container {
                margin-bottom: 15px;
            }
            .options-card-container {
                grid-template-columns: 1fr 1fr;
            }
            .guide-steps-grid {
                grid-template-columns: 1fr;
            }
        }
        /* برای صفحه‌های غیر از صفحه اصلی در دسکتاپ */
        
        @media (min-width: 769px) {
            .page:not(#manual-exam) .container {
                max-width: 1000px;
                margin: 20px auto;
                border-radius: var(--border-radius-lg);
            }
        }
        /* استایل‌های جدید برای گزینه‌های مربعی */
        
        .options-container-horizontal {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .option-square {
            width: 60px;
            height: 60px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--card-bg);
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .option-square:hover {
            background: rgba(0, 105, 148, 0.1);
            transform: translateY(-3px);
        }
        
        .option-square.selected {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
            transform: scale(1.05);
        }
        
        .option-number {
            color: var(--text-color);
        }
        
        .option-square.selected .option-number {
            color: white;
        }
        /* اضافه کردن این استایل‌ها به بخش CSS */
        
        .question-slicing-section {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            background: var(--card-bg);
        }
        
        .toggle-slicing-btn {
            padding: 8px 15px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .toggle-slicing-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }
        /* بهبود ظاهر سوالات */
        
        .question-card-improved {
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 25px;
            background: var(--card-bg);
            transition: var(--transition);
            position: relative;
            margin-bottom: 25px;
            box-shadow: var(--shadow-light);
        }
        
        .question-card-improved:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .question-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.3rem;
            font-family: "BNaznin", Vazirmatn, sans-serif;
        }
        
        .question-image {
            width: 100%;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            margin-bottom: 20px;
            max-height: 300px;
            object-fit: contain;
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            .exam-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            .timer-container {
                margin-bottom: 15px;
            }
            .filters {
                flex-wrap: wrap;
            }
            .options-container {
                flex-direction: column;
            }
            .option-item {
                min-width: auto;
            }
            .modal-buttons {
                flex-direction: column;
            }
            .progress-item {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            .options-card-container {
                grid-template-columns: 1fr 1fr;
            }
            .prompt-buttons {
                flex-direction: column;
            }
            .form-actions {
                flex-direction: column;
            }
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .question-options-grid {
                grid-template-columns: 1fr;
            }
            .guide-steps-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .options-card-container {
                grid-template-columns: 1fr;
            }
            .theme-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
            .result-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body data-theme="ocean">
    <div class="container">
        <!-- هدر جدید -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-graduation-cap"></i>
                <span>دیجیتال‌یار</span>
            </div>

            <div class="header-controls">
                <button class="back-btn" onclick="goToIndex()" title="بازگشت به صفحه اصلی">
                    <i class="fas fa-arrow-right"></i>
                    <span>بازگشت</span>
                </button>
                <div class="theme-selector">
                    <button class="theme-btn active" data-theme="ocean" title="تم اقیانوس">
              <i class="fas fa-water"></i>
            </button>
                    <button class="theme-btn" data-theme="beach" title="تم ساحل">
              <i class="fas fa-umbrella-beach"></i>
            </button>
                    <button class="theme-btn" data-theme="galaxy" title="تم کهکشان">
              <i class="fas fa-gem"></i>
            </button>
                    <button class="theme-btn" data-theme="coal-mine" title="تم معدن زغال سنگ">
              <i class="fas fa-mountain"></i>
            </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- صفحه آماده‌سازی آزمون دستی -->
            <div id="manual-exam" class="page active">
                <div class="form-container full-page-container">
                    <!-- جایگزین کردن بخش راهنمای آزمون با این کد -->
                    <div class="accordion-section">
                        <div class="accordion-header" onclick="toggleAccordion('exam-guide')">
                            <h2><i class="fas fa-info-circle"></i> راهنمای جامع آزمون</h2>
                            <span class="accordion-icon"><i class="fas fa-chevron-down"></i></span>
                        </div>
                        <div class="accordion-content" id="exam-guide">
                            <div class="guide-steps-grid">
                                <div class="guide-step-card">
                                    <div class="step-number">1</div>
                                    <div class="step-title">آپلود فایل سوالات</div>
                                    <div class="step-description">فایل سوالات یا عکس سوال خود را در برنامه آپلود کنید.</div>
                                </div>

                                <div class="guide-step-card">
                                    <div class="step-number">2</div>
                                    <div class="step-title">انتخاب تعداد گزینه‌ها</div>
                                    <div class="step-description">تعداد گزینه‌های هر سوال را مشخص کنید (۲ تا ۵ گزینه).</div>
                                </div>

                                <div class="guide-step-card">
                                    <div class="step-number">3</div>
                                    <div class="step-title">تعیین زمان آزمون</div>
                                    <div class="step-description">زمان مورد نیاز برای آزمون را بر حسب دقیقه وارد کنید.</div>
                                </div>

                                <div class="guide-step-card">
                                    <div class="step-number">4</div>
                                    <div class="step-title">دریافت کلید آزمون</div>
                                    <div class="step-description">کلید آزمون را از هوش مصنوعی دریافت کرده و در فیلد مربوطه وارد کنید.</div>
                                </div>

                                <div class="guide-step-card">
                                    <div class="step-number">5</div>
                                    <div class="step-title">ساخت آزمون</div>
                                    <div class="step-description">بر روی گزینه «ساخت آزمون» کلیک کنید تا فرآیند ایجاد آزمون آغاز شود.</div>
                                </div>

                                <div class="guide-step-card">
                                    <div class="step-number">6</div>
                                    <div class="step-title">شرکت در آزمون</div>
                                    <div class="step-description">در آزمون شرکت کرده و به سوالات پاسخ دهید.</div>
                                </div>
                                <div class="important-notice" style="margin-top: 15px; grid-column: 1 / -1;">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <span><strong>تذکر مهم:</strong> پس از دریافت پاسخ از هوش مصنوعی، محتوای دریافتی را در فیلد مربوطه پیست کنید.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- آپلود فایل -->
                    <div class="form-group">
                        <label>آپلود فایل سوالات:</label>
                        <div class="file-upload-container" onclick="document.getElementById('file-upload').click()">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">
                                <h3>فایل سوالات خود را اینجا رها کنید یا کلیک کنید</h3>
                                <p>می‌توانید فایل PDF یا تصاویر سوالات را آپلود کنید</p>
                            </div>
                            <input type="file" id="file-upload" accept=".pdf,.png,.jpg,.jpeg" style="display: none" onchange="handleFileUpload(this)" />
                            <div class="file-formats">
                                <span class="format-badge">PDF</span>
                                <span class="format-badge">PNG</span>
                                <span class="format-badge">JPG</span>
                                <span class="format-badge">JPEG</span>
                            </div>
                        </div>
                        <img id="upload-preview" class="upload-preview" alt="پیش‌نمایش فایل" />
                    </div>

                    <!-- تعداد گزینه‌های هر سوال -->
                    <div class="form-group">
                        <label>تعداد گزینه‌های هر سوال:</label>
                        <div class="options-card-container">
                            <div class="option-card" data-options="2" onclick="selectOptionCard(this)">
                                <h3>۲ گزینه‌ای</h3>
                                <p>صحیح/غلط یا دو گزینه‌ای</p>
                            </div>
                            <div class="option-card" data-options="3" onclick="selectOptionCard(this)">
                                <h3>۳ گزینه‌ای</h3>
                                <p>سوالات سه گزینه‌ای</p>
                            </div>
                            <div class="option-card selected" data-options="4" onclick="selectOptionCard(this)">
                                <h3>۴ گزینه‌ای</h3>
                                <p>سوالات استاندارد</p>
                            </div>
                            <div class="option-card" data-options="5" onclick="selectOptionCard(this)">
                                <h3>۵ گزینه‌ای</h3>
                                <p>سوالات پنج گزینه‌ای</p>
                            </div>
                        </div>
                    </div>

                    <!-- زمان آزمون -->
                    <div class="timer-input-container">
                        <label>زمان آزمون (دقیقه):</label>
                        <div class="timer-input-stretched">
                            <input type="number" id="timer-input" min="1" value="120" class="stretched-input" />
                            <span class="minute-label">دقیقه</span>
                        </div>
                    </div>

                    <!-- بخش کلید آزمون -->
                    <div class="exam-key-section">
                        <div class="exam-key-header">
                            <h4><i class="fas fa-key"></i> کلید آزمون</h4>
                        </div>

                        <div class="prompt-section" style="margin-top: 15px;">
                            <h5><i class="fas fa-robot"></i> پرامپت هوش مصنوعی برای دریافت کلید آزمون</h5>
                            <p>پرامپت را کپی کرده و به همراه فایل پاسخنامه تشریحی برای هوش مصنوعی خارجی ارسال کنید:</p>
                            <div class="prompt-buttons">
                                <button class="prompt-btn" onclick="copyPrompt('key')">
                <i class="fas fa-copy"></i> کپی پرامپت کلید آزمون
            </button>
                                <button class="prompt-btn" onclick="pasteToExamKey()">
                <i class="fas fa-paste"></i> پیست کلید آزمون
            </button>
                            </div>
                        </div>

                        <div style="position: relative; margin-top: 15px;">
                            <textarea id="exam-key" class="exam-key-input" placeholder="پاسخ دریافتی از هوش مصنوعی را اینجا پیست کنید"></textarea>
                            <button class="paste-btn" onclick="pasteToExamKey()" title="پیست کردن از کلیپ‌بورد">
            <i class="fas fa-paste"></i>
        </button>
                        </div>

                        <!-- تذکر مهم اینجا حذف شده -->
                    </div>

                    <!-- بخش برش سوالات -->
                    <div class="question-slicing-section">
                        <div class="section-header">
                            <h4><i class="fas fa-scissors"></i> برش سوالات (اختیاری)</h4>
                            <button class="toggle-slicing-btn" onclick="toggleSlicingSection()">
            <i class="fas fa-chevron-down"></i> نمایش برش سوالات
        </button>
                        </div>

                        <div class="section-content" id="question-slicing-section" style="display: none;">
                            <!-- تذکر مهم اضافه شده -->
                            <div class="important-notice" style="margin-bottom: 15px;">
                                <i class="fas fa-exclamation-circle"></i>
                                <span><strong>تذکر مهم:</strong> پس از دریافت پاسخ از هوش مصنوعی، محتوای دریافتی را در فیلد مربوطه پیست کنید.</span>
                            </div>

                            <div class="prompt-section">
                                <h5><i class="fas fa-robot"></i> پرامپت‌های هوش مصنوعی</h5>
                                <p>پرامپت را کپی کرده و به همراه فایل سوالات برای هوش مصنوعی خارجی ارسال کنید:</p>
                                <div class="prompt-buttons">
                                    <button class="prompt-btn" onclick="copyPrompt('json')">
                    <i class="fas fa-copy"></i> کپی پرامپت JSON برش
                </button>
                                    <button class="prompt-btn" onclick="pasteToJsonField()">
                    <i class="fas fa-paste"></i> پیست کد JSON
                </button>
                                </div>
                            </div>

                            <div class="input-group">
                                <label for="json-code">کد JSON برش سوالات:</label>
                                <div class="copy-btn" onclick="copyPrompt('json')">
                                    <i class="fas fa-copy"></i>
                                </div>
                                <textarea id="json-code" placeholder='پاسخ دریافتی از هوش مصنوعی را اینجا پیست کنید'></textarea>
                            </div>
                        </div>
                    </div>


                    <!-- دکمه‌های اقدام -->
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="createExam()">
                <i class="fas fa-play"></i> ساخت آزمون
            </button>

                        <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-right"></i> بازگشت
            </button>
                    </div>
                </div>
            </div>

            <!-- صفحه آزمون فعال -->
            <div id="manual-exam-page" class="page">
                <div class="form-container">
                    <div class="exam-header">
                        <h3 class="exam-title" id="exam-name">آزمون دستی</h3>
                        <div class="timer-container">
                            <div class="timer" id="exam-timer">120:00</div>
                            <button class="btn btn-primary" id="start-exam-btn" onclick="startExam()">
                  <i class="fas fa-play"></i> شروع آزمون
                </button>
                            <button class="toggle-timer" id="hide-timer-btn" onclick="toggleTimerVisibility()">
                  <i class="fas fa-eye-slash"></i>
                </button>
                        </div>
                    </div>

                    <div class="filters">
                        <button class="filter-btn active" onclick="filterQuestions('all')">
                همه سوالات
              </button>
                        <button class="filter-btn" onclick="filterQuestions('not-answered')">
                پاسخ داده نشده
              </button>
                        <button class="filter-btn" onclick="filterQuestions('answered')">
                پاسخ داده شده
              </button>
                    </div>

                    <!-- نوار وضعیت سوالات -->
                    <div class="progress-bar" id="progress-bar">
                        <!-- نوار وضعیت اینجا ساخته می‌شود -->
                    </div>

                    <div class="questions-container" id="questions-container">
                        <!-- سوالات اینجا نمایش داده می‌شوند -->
                    </div>

                    <!-- صفحه‌بندی -->
                    <div class="pagination" id="pagination">
                        <!-- دکمه‌های صفحه‌بندی اینجا ساخته می‌شوند -->
                    </div>

                    <div class="exam-actions">
                        <button class="btn btn-success" onclick="confirmFinishExam()">
                <i class="fas fa-flag-checkered"></i> پایان آزمون
              </button>
                        <button class="btn btn-secondary" onclick="showPage('manual-exam')">
                <i class="fas fa-arrow-right"></i> بازگشت
              </button>
                    </div>
                </div>
            </div>

            <!-- صفحه نتایج - بخش تغییر یافته -->
            <div id="result-page" class="page">
                <div class="form-container">
                    <div class="result-page">
                        <h2><i class="fas fa-chart-line"></i> نتایج آزمون</h2>

                        <!-- نمایش آمار آزمون -->
                        <div class="result-container" id="exam-stats">
                            <div class="result-header">
                                <h3>خلاصه عملکرد شما</h3>
                                <div class="result-score" id="answered-count">0</div>
                                <p>سوال پاسخ داده شده</p>
                            </div>

                            <div class="result-details">
                                <div class="result-detail-card">
                                    <h4>کل سوالات</h4>
                                    <p id="total-questions">0</p>
                                </div>
                                <div class="result-detail-card">
                                    <h4>سوالات بی‌پاسخ</h4>
                                    <p id="unanswered-count">0</p>
                                </div>
                                <div class="result-detail-card">
                                    <h4>زمان صرف شده</h4>
                                    <p id="time-spent">00:00:00</p>
                                </div>
                                <div class="result-detail-card">
                                    <h4>درصد پاسخ‌ها</h4>
                                    <p id="answer-percentage">0%</p>
                                </div>
                            </div>
                        </div>

                        <!-- فیلد پاسخ دانش‌آموز (مخفی شده) -->
                        <div class="input-group" style="display: none">
                            <label for="student-answers">پاسخ‌های شما:</label>
                            <div class="copy-btn" onclick="copyStudentAnswers()">
                                <i class="fas fa-copy"></i>
                            </div>
                            <textarea id="student-answers" placeholder="برای دریافت کارنامه، پاسخ خود را کپی کرده و وارد برگه‌یار شوید" readonly></textarea>
                        </div>

                        <!-- دکمه کپی پاسخ (مخفی شده) -->
                        <!-- در صفحه result-page -->
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="copyStudentAnswers()" style="display: none">
                  <i class="fas fa-copy"></i> کپی کردن پاسخ
                </button>
                            <button class="btn btn-success" onclick="goToAnswerSheet()">
                  <i class="fas fa-external-link-alt"></i>انتقال به برگه یار و
                  نمایش کارنامه
                </button>
                            <button class="btn btn-secondary" onclick="showPage('manual-exam')">
                  <i class="fas fa-arrow-right"></i> بازگشت به صفحه اصلی
                </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>
                ساخته شده با ❤️ | پشتیبانی: support.azmoonyar@gmail.com | نسخه ۴.۰.۰
            </p>
        </div>
    </div>

    <!-- مودال پایان آزمون -->
    <div class="modal" id="finishModal">
        <div class="modal-content">
            <h3>آیا از پایان آزمون مطمئن هستید؟</h3>
            <p>با تایید، آزمون به پایان خواهد رسید و پاسخ‌های شما ثبت می‌شود.</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="finishExam()">
            بله، پایان آزمون
          </button>
                <button class="btn btn-secondary" onclick="closeModal('finishModal')">
            خیر، ادامه آزمون
          </button>
            </div>
        </div>
    </div>

    <!-- مودال زمان پایان یافته -->
    <div class="modal" id="timeoutModal">
        <div class="modal-content">
            <h3>زمان شما به پایان رسید</h3>
            <p>آیا می‌خواهید آزمون را ادامه دهید یا به پایان برسانید?</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="continueExam()">
            ادامه آزمون
          </button>
                <button class="btn btn-secondary" onclick="finishExam()">
            پایان آزمون
          </button>
            </div>
        </div>
    </div>

    <script>
        // تغییر تم
        document.querySelectorAll(".theme-btn").forEach((btn) => {
            btn.addEventListener("click", function() {
                const theme = this.getAttribute("data-theme");

                // حذف کلاس active از تمام دکمه‌ها
                document.querySelectorAll(".theme-btn").forEach((b) => {
                    b.classList.remove("active");
                });

                // اضافه کردن کلاس active به دکمه انتخاب شده
                this.classList.add("active");

                // اعمال تم انتخاب شده
                document.body.setAttribute("data-theme", theme);

                // ذخیره تم در localStorage
                localStorage.setItem("selectedTheme", theme);
            });
        });

        // بارگذاری تم ذخیره شده
        window.addEventListener("DOMContentLoaded", function() {
            const savedTheme = localStorage.getItem("selectedTheme") || "ocean";
            document.body.setAttribute("data-theme", savedTheme);

            // فعال کردن دکمه تم ذخیره شده
            document
                .querySelectorAll(`.theme-btn[data-theme="${savedTheme}"]`)
                .forEach((btn) => {
                    btn.classList.add("active");
                });
        });

        // پرامپت‌ها
        const prompts = {
            json: `فایل PDF یا تصویر پیوست‌شده حاوی سوالات آزمون است. لطفاً فقط صفحات دارای سوالات شماره‌گذاری‌شده (مانند ۱، ۲، ۳، ۴، ۵، ۶، ۷، ۸، ۹، ۱۰ و غیره با استفاده از اعداد فارسی) را پردازش کن و صفحات بدون شماره سوال (مانند صفحه کاور، صفحات حاوی اطلاعات آزمون، صفحات خالی، پاسخ‌برگ‌ها، یا هر صفحه‌ای که فاقد ستون عمودی شماره سوالات است) را کاملاً نادیده بگیر. شماره سوالات همیشه به صورت اعداد فارسی (۱، ۲، ۳...) در یک ستون عمودی در سمت راست‌ترین قسمت صفحه (یعنی راست‌ترین ستون اعداد، معمولاً نزدیک حاشیه راست صفحه) قرار دارند. این ستون معمولاً شامل شماره‌های متوالی است و ممکن است با خطوط افقی یا عمودی جدا شده باشد.

برای دستیابی به بیشترین دقت در برش، از ابزارهای تحلیل تصویر پیشرفته استفاده کن. مرزهای هر سوال را با دقت پیکسلی شناسایی کن: y1 را دقیقاً از پیکسل شروع بالاترین عنصر و y2 را دقیقاً تا پیکسل پایان پایین‌ترین عنصر تنظیم کن، بدون هیچ هم‌پوشانی یا فاصله اضافی.

فرض کن DPI = ۶۰۰ برای تبدیل PDF به تصویر، و عرض صفحه دقیقاً ۳۶۰۰ پیکسل است.

خروجی باید فقط JSON باشد با فرمت دقیق زیر:

{
  "صفحه_X": [
    { "شماره": "N", "x1": 0, "y1": Y1, "x2": 3600, "y2": Y2 }
  ]
}

که در آن:
- X شماره صفحه واقعی در PDF است
- N شماره سوال است (به صورت رشته با اعداد فارسی)
- Y1 و Y2 مختصات عمودی بر حسب پیکسل هستند

لطفاً فقط کد JSON خالص بدون هیچ متن اضافی تولید کن.`,

            key: `۲. پردازش پاسخنامه تشریحی (کلید آزمون):
            - پاسخ‌های صحیح را از پاسخنامه استخراج کن
            - اطلاعات زیر را تشخیص بده:
              * تعداد سوالات واقعی
              * نام هر درس
              * نوع درس (فقط "عمومی" یا "تخصصی")
              * بازه سوالات هر درس
              * مباحث درسی (برای دروس تخصصی)
            در نهایت اول کلید و بعد اطلاعات را با یک خط فاصله به کاربر میدی در اطلاعات هم هر چیزی که هست چه درس چه تاریخ با یک خط فاصله ارسال میشود
            فرمت خروجی دقیق:
            [پاسخ‌های صحیح]total_questions:[عدد]|subject:[نام درس]|type:[نوع]|start:[شروع]|end:[پایان]|chapters:[مباحث]

            مثال خروجی:
            1234213421...total_questions:250|subject:زبان|type:عمومی|start:1|end:30|subject:ریاضی|type:تخصصی|start:31|end:120|chapters:1,2,3

            ---

            قوانین سخت‌گیرانه:
            ✅ فقط داده‌های خام برگردان
            ✅ هیچ متن اضافی ننویس
            ✅ از فرمت دقیقاً پیروی کن
            ✅ فقط اعداد انگلیسی استفاده کن
            ✅ فیلدها با | جدا شوند
            ✅ نوع درس فقط "عمومی" یا "تخصصی" است
            ✅ chapters فقط برای دروس تخصصی
            ✅ طول رشته پاسخ‌ها = تعداد سوالات
            هر کدوم از کد ها رو جداجدا میفرستی و طوری باشه دانش اموز با کلیک روی ان کپی کن`,
        };

        // اطلاعات آزمون
        let examData = {
            questions: [],
            totalQuestions: 0,
            optionsCount: 4,
            timerInterval: null,
            timeRemaining: 7200, // 120 دقیقه به ثانیه
            examName: "آزمون دستی",
            answers: {},
            currentPage: 1,
            questionsPerPage: 10,
            examStarted: false,
            timerHidden: false,
        };

        // انتخاب کارت تعداد گزینه‌ها
        function selectOptionCard(card) {
            document.querySelectorAll(".option-card").forEach((c) => {
                c.classList.remove("selected");
            });

            card.classList.add("selected");
            examData.optionsCount = parseInt(card.getAttribute("data-options"));
        }

        // آپلود فایل
        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                examData.examName = fileName;

                // نمایش پیش‌نمایش برای تصاویر
                if (input.files[0].type.includes("image")) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById("upload-preview");
                        preview.src = e.target.result;
                        preview.style.display = "block";
                    };
                    reader.readAsDataURL(input.files[0]);
                }

                showNotification(`فایل "${fileName}" با موفقیت آپلود شد`);
            }
        }

        // کپی پرامپت
        function copyPrompt(type) {
            navigator.clipboard
                .writeText(prompts[type])
                .then(() => {
                    showNotification("پرامپت با موفقیت کپی شد!");
                })
                .catch((err) => {
                    showNotification("خطا در کپی پرامپت: " + err.message);
                });
        }

        // تابع اصلاح شده برای پردازش JSON
        function cleanAndParseJSON(jsonString) {
            try {
                console.log("JSON خام ورودی:", jsonString);

                // اگر JSON قبلاً پارس شده باشد، آن را برگردان
                if (typeof jsonString === "object") {
                    return jsonString;
                }

                // حذف کاراکترهای غیر ضروری از ابتدا و انتها
                let cleanedJSON = jsonString
                    .replace(/^[^{[]*([{[])/, "$1") // حذف همه چیز قبل از اولین { یا [
                    .replace(/([}\]])[^}\]]*$/, "$1") // حذف همه چیز بعد از آخرین } یا ]
                    .trim();

                console.log("JSON پس از پاکسازی:", cleanedJSON);

                // بررسی اینکه آیا JSON معتبر است
                if (!cleanedJSON.startsWith("{") && !cleanedJSON.startsWith("[")) {
                    throw new Error("فرمت JSON نامعتبر است");
                }

                return JSON.parse(cleanedJSON);
            } catch (error) {
                console.error("خطای نهایی در پردازش JSON:", error);
                throw new Error(
                    `خطا در پردازش JSON: ${error.message}. لطفاً مطمئن شوید که فقط کد JSON خالص را وارد کرده‌اید.`
                );
            }
        }

        // تابع detectAndScaleCoordinates را با این نسخه جایگزین کنید
        function detectAndScaleCoordinates(jsonData) {
            let maxXValue = 0;
            let has7200Format = false;

            // بررسی همه مقادیر x2 برای تشخیص فرمت
            for (const page in jsonData) {
                for (const question of jsonData[page]) {
                    maxXValue = Math.max(maxXValue, question.x2 || 0);
                    if (question.x2 === 7200) {
                        has7200Format = true;
                        break;
                    }
                }
                if (has7200Format) break;
            }

            console.log("بیشترین مقدار X یافت شده:", maxXValue);
            console.log("فرمت 7200 پیکسلی تشخیص داده شد:", has7200Format);

            // اگر فرمت 7200 تشخیص داده شد، مقیاس‌گذاری کن
            if (has7200Format) {
                console.log("تشخیص داده شد: فرمت مختصات 7200 پیکسلی");
                return scaleCoordinates(jsonData, 3600, 7200);
            }

            // اگر فرمت 3600 است، تغییر نده
            if (maxXValue === 3600) {
                console.log("تشخیص داده شد: فرمت مختصات 3600 پیکسلی");
                return jsonData;
            }

            console.warn(
                "فرمت مختصات ناشناخته. استفاده از مقیاس پیش‌فرض 3600 پیکسل."
            );
            // برای ایمنی، فرض می‌کنیم فرمت 7200 است و مقیاس‌گذاری می‌کنیم
            return scaleCoordinates(jsonData, 3600, 7200);
        }

        // بهبود تابع scaleCoordinates برای پشتیبانی از هر دو فرمت
        function scaleCoordinates(
            jsonData,
            targetWidth = 3600,
            originalWidth = 7200
        ) {
            // اگر عرض اصلی همان عرض هدف است، نیازی به مقیاس‌گذاری نیست
            if (originalWidth === targetWidth) {
                return jsonData;
            }

            const scaleFactor = targetWidth / originalWidth;
            const scaledData = {};

            console.log(
                `مقیاس‌گذاری مختصات از ${originalWidth} به ${targetWidth} (ضریب: ${scaleFactor})`
            );

            for (let page in jsonData) {
                scaledData[page] = jsonData[page].map((question) => {
                    const scaledQuestion = {
                        ...question,
                        x1: Math.round(question.x1 * scaleFactor),
                        x2: Math.round(question.x2 * scaleFactor),
                        y1: Math.round(question.y1 * scaleFactor),
                        y2: Math.round(question.y2 * scaleFactor),
                    };

                    console.log(
                        `سوال ${question.شماره}: (${question.x1},${question.y1})-(${question.x2},${question.y2}) → (${scaledQuestion.x1},${scaledQuestion.y1})-(${scaledQuestion.x2},${scaledQuestion.y2})`
                    );

                    return scaledQuestion;
                });
            }

            return scaledData;
        }

        // تابع createExam را با این نسخه جایگزین کنید
        async function createExam(processAllPages = false) {
            const jsonCode = document.getElementById("json-code").value.trim();
            console.log("JSON ورودی:", jsonCode);
            const fileInput = document.getElementById("file-upload");
            const pdfFile = fileInput.files[0];

            if (!jsonCode) {
                showNotification("لطفاً کد JSON را وارد کنید.", "error");
                return;
            }

            if (!pdfFile) {
                showNotification("لطفاً فایل PDF سوالات را آپلود کنید.", "error");
                return;
            }

            try {
                // پردازش و پاکسازی JSON
                const jsonData = cleanAndParseJSON(jsonCode);

                // تشخیص و مقیاس‌بندی خودکار مختصات
                const scaledData = detectAndScaleCoordinates(jsonData);

                // اعتبارسنجی مختصات
                const validatedData = validateCoordinates(scaledData);

                // پردازش سوالات از JSON
                const questions = await processQuestionsFromJSON(
                    validatedData,
                    pdfFile,
                    processAllPages
                );

                examData.totalQuestions = questions.length;
                examData.timeRemaining =
                    parseInt(document.getElementById("timer-input").value) * 60;
                examData.questions = questions;
                examData.answers = {};
                examData.currentPage = 1;
                examData.examStarted = false;

                // نمایش نام آزمون
                document.getElementById("exam-name").textContent = examData.examName;

                // نمایش سوالات
                displayQuestions();

                // ایجاد نوار وضعیت
                createProgressBar();

                // ایجاد صفحه‌بندی
                createPagination();

                // رفتن به صفحه آزمون
                showPage("manual-exam-page");

                showNotification(
                    `آزمون با ${examData.totalQuestions} سوال ایجاد شد!` +
                    (processAllPages ? "" : " (۱۰ سوال اول نمایش داده می‌شوند)"),
                    "success"
                );

                // اگر همه صفحات پردازش نشده‌اند، پس‌زمینه بقیه را پردازش کن
                if (!processAllPages) {
                    processRemainingPagesInBackground(jsonData, pdfFile);
                }
            } catch (error) {
                showNotification("خطا در پردازش: " + error.message, "error");
            }
        }

        // تابع جدید برای پردازش پس‌زمینه صفحات باقیمانده
        async function processRemainingPagesInBackground(jsonData, pdfFile) {
            try {
                console.log("پردازش پس‌زمینه صفحات باقیمانده آغاز شد");

                // پردازش همه صفحات
                const allQuestions = await processQuestionsFromJSON(
                    jsonData,
                    pdfFile,
                    true // processAllPages = true
                );

                // به روزرسانی داده‌های آزمون با سوالات کامل
                examData.questions = allQuestions;
                examData.totalQuestions = allQuestions.length;

                console.log("پردازش پس‌زمینه صفحات با موفقیت انجام شد");
                showNotification("همه سوالات در پس‌زمینه پردازش شدند", "info");
            } catch (error) {
                console.error("خطا در پردازش پس‌زمینه:", error);
            }
        }

        // ایجاد نوار وضعیت سوالات
        function createProgressBar() {
            const progressBar = document.getElementById("progress-bar");
            progressBar.innerHTML = "";

            const startQuestion =
                (examData.currentPage - 1) * examData.questionsPerPage + 1;
            const endQuestion = Math.min(
                startQuestion + examData.questionsPerPage - 1,
                examData.totalQuestions
            );

            for (let i = startQuestion; i <= endQuestion; i++) {
                const progressItem = document.createElement("div");
                progressItem.className = "progress-item";
                progressItem.textContent = i;
                progressItem.onclick = () => scrollToQuestion(i);

                if (i === startQuestion) {
                    progressItem.classList.add("current");
                }

                if (examData.answers[i]) {
                    progressItem.classList.add("answered");
                }

                progressBar.appendChild(progressItem);
            }
        }

        // پیمایش به سوال خاص
        function scrollToQuestion(questionNumber) {
            const questionElement = document.getElementById(
                `question-${questionNumber}`
            );
            if (questionElement) {
                questionElement.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                });

                // هایلایت سوال در نوار وضعیت
                document.querySelectorAll(".progress-item").forEach((item) => {
                    item.classList.remove("current");
                    if (parseInt(item.textContent) === questionNumber) {
                        item.classList.add("current");
                    }
                });
            }
        }

        // شروع آزمون
        function startExam() {
            examData.examStarted = true;
            document.getElementById("start-exam-btn").style.display = "none";
            startTimer();
            showNotification("آزمون شروع شد! زمان در حال محاسبه است.");
        }

        // شروع تایمر آزمون
        function startTimer() {
            // اگر تایمر در حال اجراست، متوقفش کن
            if (examData.timerInterval) {
                clearInterval(examData.timerInterval);
            }

            const timerElement = document.getElementById("exam-timer");

            examData.timerInterval = setInterval(() => {
                examData.timeRemaining--;

                if (examData.timeRemaining <= 0) {
                    clearInterval(examData.timerInterval);
                    showTimeoutModal();
                    return;
                }

                // به روزرسانی نمایش تایمر
                const hours = Math.floor(examData.timeRemaining / 3600);
                const minutes = Math.floor((examData.timeRemaining % 3600) / 60);
                const seconds = examData.timeRemaining % 60;

                timerElement.textContent = `${hours
            .toString()
            .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
            }, 1000);
        }

        // مخفی/نمایش تایمر
        function toggleTimerVisibility() {
            examData.timerHidden = !examData.timerHidden;
            const timer = document.getElementById("exam-timer");
            const hideBtn = document.getElementById("hide-timer-btn");

            if (examData.timerHidden) {
                timer.classList.add("hidden");
                hideBtn.innerHTML = '<i class="fas fa-eye"></i>';
            } else {
                timer.classList.remove("hidden");
                hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            }
        }

        // نمایش سوالات در صفحه آزمون
        function displayQuestions() {
            const container = document.getElementById("questions-container");
            container.innerHTML = "";

            const startIndex =
                (examData.currentPage - 1) * examData.questionsPerPage;
            const endIndex = Math.min(
                startIndex + examData.questionsPerPage,
                examData.totalQuestions
            );

            for (let i = startIndex; i < endIndex; i++) {
                const question = examData.questions[i];

                // ایجاد کارت سوال به سبک DigitalYar
                const questionCard = document.createElement("div");
                questionCard.className = "question-card";
                questionCard.id = `question-${question.number}`;

                if (
                    examData.currentFilter === "not-answered" &&
                    examData.answers[question.number]
                ) {
                    questionCard.classList.add("filtered");
                }

                const optionLetters = ["۱", "۲", "۳", "۴", "۵"];
                let optionsHTML = "";

                for (let j = 0; j < examData.optionsCount; j++) {
                    optionsHTML += `
                            <div class="option-item" onclick="selectOptionForQuestion(${
                              question.number
                            }, ${j + 1})">
                                <div class="option-marker">${
                                  optionLetters[j]
                                }</div>
                            </div>
                        `;
                }

                questionCard.innerHTML = `
          <div class="question-number">سوال ${question.number}</div>
          <div style="position: relative;">
              <img src="${question.image}" class="question-image" alt="سوال ${question.number}" onclick="zoomQuestionImage('${question.image}')">
              <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="zoomQuestionImage('${question.image}')">
                  <i class="fas fa-search-plus"></i>
              </div>
          </div>
          <div class="options-container">
              ${optionsHTML}
          </div>
      `;

                container.appendChild(questionCard);

                // اگر پاسخ قبلی وجود دارد، آن را نمایش بده
                if (examData.answers[question.number]) {
                    updateQuestionDisplay(
                        question.number,
                        examData.answers[question.number]
                    );
                }
            }
        }

        // تغییر تابع selectOptionForQuestion
        function selectOptionForQuestion(questionNumber, optionNumber) {
            if (!examData.examStarted) {
                showNotification(
                    "لطفاً ابتدا آزمون را شروع کنید! روی دکمه 'شروع آزمون' کلیک کنید.",
                    "error"
                );
                return;
            }

            // اگر گزینه قبلاً انتخاب شده بود، آن را حذف کن
            if (examData.answers[questionNumber] === optionNumber) {
                examData.answers[questionNumber] = null;
                showNotification(`پاسخ سوال ${questionNumber} حذف شد`, "info");
            } else {
                // در غیر این صورت، گزینه جدید را انتخاب کن
                examData.answers[questionNumber] = optionNumber;
                showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, "success");
            }

            // به روزرسانی نمایش
            updateQuestionDisplay(questionNumber, examData.answers[questionNumber]);

            // به روزرسانی نوار وضعیت
            updateProgressBar();
        }

        // ذخیره پاسخ
        examData.answers[questionNumber] = optionNumber;

        // به روزرسانی نمایش
        updateQuestionDisplay(questionNumber, optionNumber);

        // به روزرسانی نوار وضعیت
        updateProgressBar();

        showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, "success");

        // به روزرسانی نمایش سوال
        function updateQuestionDisplay(questionNumber, optionNumber) {
            const questionCard = document.getElementById(
                `question-${questionNumber}`
            );
            if (!questionCard) return;

            // به روزرسانی ظاهر گزینه‌ها
            questionCard.querySelectorAll(".option-item").forEach((item, index) => {
                item.classList.remove("selected");
                if (index + 1 === optionNumber) {
                    item.classList.add("selected");
                }
            });
        }

        // به روزرسانی نوار وضعیت
        function updateProgressBar() {
            document.querySelectorAll(".progress-item").forEach((item) => {
                const questionNumber = parseInt(item.textContent);
                if (examData.answers[questionNumber]) {
                    item.classList.add("answered");
                } else {
                    item.classList.remove("answered");
                }
            });
        }

        // ایجاد صفحه‌بندی
        function createPagination() {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            const totalPages = Math.ceil(
                examData.totalQuestions / examData.questionsPerPage
            );

            if (totalPages > 1) {
                // دکمه قبلی
                if (examData.currentPage > 1) {
                    const prevBtn = document.createElement("button");
                    prevBtn.className = "page-btn";
                    prevBtn.innerHTML = '<i class="fas fa-arrow-right"></i> قبلی';
                    prevBtn.onclick = () => changePage(examData.currentPage - 1);
                    pagination.appendChild(prevBtn);
                }

                // دکمه‌های صفحات
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement("button");
                    pageBtn.className = "page-btn";
                    if (i === examData.currentPage) {
                        pageBtn.classList.add("active");
                    }
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => changePage(i);
                    pagination.appendChild(pageBtn);
                }

                // دکمه بعدی
                if (examData.currentPage < totalPages) {
                    const nextBtn = document.createElement("button");
                    nextBtn.className = "page-btn";
                    nextBtn.innerHTML = 'بعدی <i class="fas fa-arrow-left"></i>';
                    nextBtn.onclick = () => changePage(examData.currentPage + 1);
                    pagination.appendChild(nextBtn);
                }
            }
        }

        // تغییر صفحه
        function changePage(pageNumber) {
            examData.currentPage = pageNumber;
            displayQuestions();
            createProgressBar();
            createPagination();

            // اسکرول به بالای صفحه
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        // فیلتر کردن سوالات
        function filterQuestions(filter) {
            examData.currentFilter = filter;

            // فعال کردن دکمه فیلتر انتخاب شده
            document.querySelectorAll(".filter-btn").forEach((btn) => {
                btn.classList.remove("active");
            });
            event.target.classList.add("active");

            // اعمال فیلتر
            const questions = document.querySelectorAll(".question-card");
            questions.forEach((card) => {
                const questionNumber = parseInt(card.id.replace("question-", ""));

                card.style.display = "block";

                if (filter === "not-answered" && examData.answers[questionNumber]) {
                    card.style.display = "none";
                } else if (
                    filter === "answered" &&
                    !examData.answers[questionNumber]
                ) {
                    card.style.display = "none";
                }
            });
        }

        // نمایش مودال زمان پایان یافته
        function showTimeoutModal() {
            document.getElementById("timeoutModal").classList.add("active");
        }

        // ادامه آزمون پس از اتمام زمان
        function continueExam() {
            closeModal("timeoutModal");
            // تایمر را صفر نگه دار ولی اجازه ادامه آزمون بده
            examData.timeRemaining = 0;
            document.getElementById("exam-timer").textContent = "00:00:00";
        }

        // تابع پایان آزمون (یکپارچه برای هر دو نوع)
        function finishExam() {
            // بستن مودال‌ها
            closeModal("finishModal");
            closeModal("timeoutModal");

            // توقف تایمر
            if (examData.timerInterval) {
                clearInterval(examData.timerInterval);
                examData.timerInterval = null;
            }

            // تولید کد پاسخ برای هر دو نوع آزمون
            let answerCode = "";

            if (examData.examType === 1) {
                // برای نوع 1: تولید رشته پاسخ بر اساس تعداد سوالات
                for (let i = 1; i <= examData.totalQuestions; i++) {
                    answerCode += examData.answers[i] || "0";
                }
            } else if (examData.examType === 2) {
                // برای نوع 2: مانند قبل
                for (let i = 1; i <= examData.totalQuestions; i++) {
                    answerCode += examData.answers[i] || "0";
                }
            }

            // ذخیره پاسخ‌ها
            localStorage.setItem("studentAnswers", answerCode);
            localStorage.setItem("examTotalQuestions", examData.totalQuestions.toString());
            localStorage.setItem("examType", examData.examType.toString());
            localStorage.setItem("examName", examData.examName);

            // اگر در حالت فول‌اسکرین هستیم، خروج کنیم
            if (examData.examType === 1 && document.getElementById('type1-exam-fullscreen')) {
                exitFullscreen();
            }

            // به‌روزرسانی آمار آزمون
            updateExamStats();

            showNotification(
                "آزمون با موفقیت به پایان رسید! پاسخ‌های شما ذخیره شد.",
                "success"
            );

            // رفتن به صفحه نتایج
            setTimeout(() => {
                showPage("result-page");
            }, 1000);
        }

        // تابع تایید پایان آزمون (یکپارچه)
        function confirmFinishExam() {
            // بررسی اینکه آیا سوالی پاسخ داده شده یا نه
            const answeredCount = Object.values(examData.answers).filter(
                answer => answer !== null && answer !== undefined
            ).length;

            let message = "آیا از پایان آزمون مطمئن هستید؟";

            if (answeredCount === 0) {
                message += "\n\n⚠️ هیچ سوالی پاسخ داده نشده است!";
            } else {
                message += `\n\n✅ ${answeredCount} سوال پاسخ داده شده است.`;
            }

            message += "\n\nبا تایید، آزمون به پایان خواهد رسید و پاسخ‌های شما ثبت می‌شود.";

            // ایجاد مودال داینامیک
            const modal = document.getElementById('finishModal');
            const modalContent = modal.querySelector('.modal-content');

            modalContent.innerHTML = `
        <h3>پایان آزمون</h3>
        <p style="white-space: pre-line;">${message}</p>
        <div class="modal-buttons">
            <button class="btn btn-primary" onclick="finishExam()">
                بله، پایان آزمون
            </button>
            <button class="btn btn-secondary" onclick="closeModal('finishModal')">
                خیر، ادامه آزمون
            </button>
        </div>
    `;

            modal.classList.add('active');
        }

        // نمایش کارنامه
        function showReport() {
            const examKeyCode = document
                .getElementById("exam-key-code")
                .value.trim();

            if (!examKeyCode) {
                showNotification("لطفاً کلید آزمون را وارد کنید.", "error");
                return;
            }

            showNotification("کارنامه شما در حال محاسبه است...", "success");
            // در اینجا می‌توانید پردازش کارنامه را اضافه کنید
        }

        // بستن مودال
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove("active");
        }

        // نمایش صفحه
        function showPage(pageId) {
            document.querySelectorAll(".page").forEach((page) => {
                page.classList.remove("active");
            });
            document.getElementById(pageId).classList.add("active");
        }

        // بازگشت به صفحه قبل
        function goBack() {
            showNotification("در حال بازگشت...");
            // در اینجا می‌توانید به صفحه قبل هدایت کنید
        }

        // جایگزین کردن تابع showNotification با این نسخه
        function showNotification(message, type = "info") {
            // حذف نوتیفیکیشن‌های قبلی
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => {
                document.body.removeChild(notification);
            });

            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            notification.innerHTML = `
        <i class="fas fa-${
            type === "error" 
                ? "exclamation-circle" 
                : type === "success" 
                ? "check-circle" 
                : type === "warning"
                ? "exclamation-triangle"
                : "info-circle"
        }"></i>
        <span>${message}</span>
    `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add("show");
            }, 100);

            setTimeout(() => {
                notification.classList.remove("show");
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // اضافه کردن این متغیرهای global در ابتدای بخش script
        var pdfImages = {};
        var pdfDocument = null;
        
        // تابع بازگشت به صفحه اصلی
        function goToIndex() {
            window.location.href = 'index.html';
        }

        // تابع برای بارگذاری PDF
        async function loadPDF(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const typedArray = new Uint8Array(e.target.result);
                        pdfDocument = await pdfjsLib.getDocument(typedArray).promise;
                        resolve(pdfDocument);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // تغییر از scale = 2 به scale = 5
        async function renderPDFPage(pageNumber, scale = 5) {
            if (!pdfDocument) {
                throw new Error("PDF بارگذاری نشده است");
            }

            const page = await pdfDocument.getPage(pageNumber);
            const viewport = page.getViewport({
                scale
            }); // scale افزایش یافته

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({
                canvasContext: context,
                viewport: viewport,
            }).promise;

            return canvas.toDataURL("image/png");
        }

        // تابع برای تبدیل اعداد عربی به فارسی
        function convertArabicToPersianNumbers(str) {
            const arabicNumbers = [
                "۰",
                "۱",
                "۲",
                "۳",
                "۴",
                "۵",
                "۶",
                "۷",
                "۸",
                "۹",
            ];
            const persianNumbers = [
                "۰",
                "۱",
                "۲",
                "۳",
                "۴",
                "۵",
                "۶",
                "۷",
                "۸",
                "۹",
            ];

            return str.replace(
                /[۰-۹]/g,
                (d) => persianNumbers[arabicNumbers.indexOf(d)]
            );
        }

        // تابع برای تبدیل اعداد به انگلیسی
        function convertToEnglishNumbers(str) {
            const persianNumbers = [
                "۰",
                "۱",
                "۲",
                "۳",
                "۴",
                "۵",
                "۶",
                "۷",
                "۸",
                "۹",
            ];
            const arabicNumbers = [
                "۰",
                "۱",
                "۲",
                "۳",
                "۴",
                "۵",
                "۶",
                "۷",
                "۸",
                "۹",
            ];
            const englishNumbers = [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
            ];

            return str.replace(/[۰-۹]/g, (d) => {
                const persianIndex = persianNumbers.indexOf(d);
                if (persianIndex !== -1) return englishNumbers[persianIndex];

                const arabicIndex = arabicNumbers.indexOf(d);
                if (arabicIndex !== -1) return englishNumbers[arabicIndex];

                return d;
            });
        }

        // تابع processQuestionsFromJSON را با این نسخه جایگزین کنید
        async function processQuestionsFromJSON(
            jsonData,
            pdfFile,
            processAllPages = false
        ) {
            try {
                console.log("داده‌های JSON دریافتی:", jsonData);

                // مقداردهی اولیه pdfImages اگر تعریف نشده
                if (typeof pdfImages === "undefined") {
                    pdfImages = {};
                }

                // بارگذاری PDF اگر فایل ارائه شده
                if (pdfFile && !pdfDocument) {
                    await loadPDF(pdfFile);
                }

                const questions = [];
                let questionNumber = 1;

                // پردازش هر صفحه از JSON
                const pageKeys = Object.keys(jsonData);

                // اگر processAllPages false باشد، فقط 10 سوال اول را پردازش کن
                const maxPagesToProcess = processAllPages ? pageKeys.length : 1;

                for (let p = 0; p < maxPagesToProcess; p++) {
                    const pageKey = pageKeys[p];
                    const pageQuestions = jsonData[pageKey];

                    console.log(`پردازش صفحه: ${pageKey}`, pageQuestions);

                    // استخراج شماره صفحه از کلید
                    let pageNum;
                    if (pageKey.startsWith("صفحه_")) {
                        pageNum = parseInt(
                            convertToEnglishNumbers(pageKey.replace("صفحه_", ""))
                        );
                    } else if (pageKey.startsWith("صفحه")) {
                        pageNum = parseInt(
                            convertToEnglishNumbers(pageKey.replace("صفحه", ""))
                        );
                    } else {
                        const numbers = pageKey.match(/\d+/);
                        pageNum = numbers ?
                            parseInt(convertToEnglishNumbers(numbers[0])) :
                            1;
                    }

                    if (isNaN(pageNum)) {
                        console.warn(`شماره صفحه نامعتبر برای کلید: ${pageKey}`);
                        pageNum = 1;
                    }

                    console.log(`شماره صفحه استخراج شده: ${pageNum}`);

                    // رندر صفحه PDF (اگر قبلا رندر نشده)
                    let pageImage = pdfImages[pageNum];
                    if (!pageImage) {
                        if (pdfDocument) {
                            try {
                                pageImage = await renderPDFPage(pageNum);
                                pdfImages[pageNum] = pageImage;
                            } catch (error) {
                                console.error(`خطا در رندر صفحه ${pageNum}:`, error);
                                pageImage = `https://via.placeholder.com/800x1000/1b9aaa/ffffff?text=صفحه+${pageNum}`;
                            }
                        } else {
                            pageImage = `https://via.placeholder.com/800x1000/1b9aaa/ffffff?text=صفحه+${pageNum}`;
                        }
                    }

                    // پردازش هر سوال در صفحه
                    for (const questionData of pageQuestions) {
                        console.log(`پردازش سوال:`, questionData);

                        // تبدیل شماره سوال از عربی/فارسی به انگلیسی
                        let actualNumber = parseInt(
                            convertToEnglishNumbers(questionData.شماره)
                        );
                        if (isNaN(actualNumber)) {
                            console.warn(`شماره سوال نامعتبر: ${questionData.شماره}`);
                            actualNumber = questionNumber;
                        }

                        let questionImage = null;
                        const x1 = questionData.x1 || 0;
                        const x2 = questionData.x2 || 3600;
                        const y1 = questionData.y1 || 0;
                        const y2 = questionData.y2 || 300;

                        // برش تصویر سوال
                        try {
                            if (pageImage.startsWith("data:image")) {
                                questionImage = await cropImage(pageImage, x1, y1, x2, y2);
                            } else {
                                // اگر تصویر صفحه placeholder است، از همان استفاده کن
                                questionImage = pageImage;
                            }
                        } catch (error) {
                            console.error(`خطا در برش تصویر سوال ${actualNumber}:`, error);
                            questionImage = `https://via.placeholder.com/600x200/1b9aaa/ffffff?text=سوال+${actualNumber}`;
                        }

                        questions.push({
                            number: actualNumber,
                            image: questionImage,
                            options: examData.optionsCount,
                            page: pageNum,
                            coordinates: {
                                x1,
                                y1,
                                x2,
                                y2
                            },
                        });

                        questionNumber = Math.max(questionNumber, actualNumber) + 1;

                        // اگر 10 سوال پردازش شد و processAllPages false است، متوقف شو
                        if (!processAllPages && questions.length >= 10) {
                            break;
                        }
                    }

                    // اگر 10 سوال پردازش شد و processAllPages false است، متوقف شو
                    if (!processAllPages && questions.length >= 10) {
                        break;
                    }
                }

                if (questions.length === 0) {
                    throw new Error("هیچ سوالی از JSON استخراج نشد");
                }

                questions.sort((a, b) => a.number - b.number);
                console.log("سوالات ایجاد شده:", questions);
                return questions;
            } catch (error) {
                console.error("خطا در پردازش سوالات:", error);
                throw error;
            }
        }

        function cropImage(imageSrc, x1, y1, x2, y2) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    // اضافه کردن حاشیه 15 پیکسلی
                    const margin = 15;
                    const adjustedY1 = Math.max(0, y1 - margin);
                    const adjustedY2 = Math.min(img.height, y2 + margin);

                    const width = x2 - x1;
                    const height = adjustedY2 - adjustedY1;

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(
                        img,
                        x1,
                        adjustedY1,
                        width,
                        height,
                        0,
                        0,
                        width,
                        height
                    );

                    resolve(canvas.toDataURL("image/png"));
                };
                img.onerror = reject;
                img.src = imageSrc;
            });
        }

        // زوم تصویر سوال - نسخه بهبود یافته
        function zoomQuestionImage(imageSrc) {
            // غیرفعال کردن اسکرول صفحه
            document.body.classList.add("modal-open");

            // ایجاد مودال زوم
            const zoomModal = document.createElement("div");
            zoomModal.className = "image-zoom-modal active";
            zoomModal.innerHTML = `
      <span class="close-zoom" onclick="closeImageZoom()">&times;</span>
      <div class="zoomed-image-container">
        <img class="zoomed-image" src="${imageSrc}" alt="تصویر سوال">
      </div>
    `;

            // بستن مودال با کلیک روی پس‌زمینه
            zoomModal.onclick = function(e) {
                if (e.target === zoomModal) {
                    closeImageZoom();
                }
            };

            document.body.appendChild(zoomModal);

            // جلوگیری از اسکرول هنگام نمایش مودال
            document.addEventListener("wheel", preventScroll, {
                passive: false
            });
            document.addEventListener("touchmove", preventScroll, {
                passive: false,
            });
        }

        // بستن زوم تصویر
        function closeImageZoom() {
            const zoomModal = document.querySelector(".image-zoom-modal");
            if (zoomModal) {
                zoomModal.classList.remove("active");
                setTimeout(() => {
                    document.body.removeChild(zoomModal);
                    document.body.classList.remove("modal-open");

                    // حذف event listeners برای جلوگیری از اسکرول
                    document.removeEventListener("wheel", preventScroll);
                    document.removeEventListener("touchmove", preventScroll);
                }, 300);
            }
        }

        // جلوگیری از اسکرول
        function preventScroll(e) {
            e.preventDefault();
            return false;
        }

        // تولید رشته پاسخ دانش‌آموز
        function generateStudentAnswersString() {
            let answerString = "";

            for (let i = 1; i <= examData.totalQuestions; i++) {
                // اگر پاسخی وجود دارد، آن را اضافه کن، در غیر این صورت 0
                answerString += examData.answers[i] || "0";
            }

            return answerString;
        }

        // کپی پاسخ دانش‌آموز
        function copyStudentAnswers() {
            const studentAnswers = document.getElementById("student-answers").value;

            if (!studentAnswers) {
                showNotification("هیچ پاسخی برای کپی کردن وجود ندارد.", "error");
                return;
            }

            navigator.clipboard
                .writeText(studentAnswers)
                .then(() => {
                    showNotification("پاسخ‌های دانش‌آموز با موفقیت کپی شد!");
                })
                .catch((err) => {
                    showNotification("خطا در کپی پاسخ‌ها: " + err.message, "error");
                });
        }

        // بارگذاری پاسخ‌های ذخیره شده
        function loadSavedAnswers() {
            const savedAnswers = localStorage.getItem("studentAnswers");

            if (savedAnswers) {
                document.getElementById("student-answers").value = savedAnswers;

                // همچنین پاسخ‌ها را در examData نیز بارگذاری کنید
                for (let i = 0; i < savedAnswers.length; i++) {
                    const answer = parseInt(savedAnswers[i]);
                    if (answer > 0) {
                        examData.answers[i + 1] = answer;
                    }
                }
            }
        }

        // تابع برای به‌روزرسانی آمار نتایج
        function updateExamStats() {
            // محاسبه تعداد سوالات پاسخ داده شده
            const answeredCount = Object.values(examData.answers).filter(
                (answer) => answer !== null && answer !== undefined
            ).length;

            // محاسبه تعداد سوالات بی‌پاسخ
            const unansweredCount = examData.totalQuestions - answeredCount;

            // محاسبه زمان صرف شده
            const totalTimeSeconds =
                parseInt(document.getElementById("timer-input").value) * 60 -
                examData.timeRemaining;
            const hours = Math.floor(totalTimeSeconds / 3600);
            const minutes = Math.floor((totalTimeSeconds % 3600) / 60);
            const seconds = totalTimeSeconds % 60;
            const timeSpent = `${hours.toString().padStart(2, "0")}:${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

            // محاسبه درصد پاسخ‌ها
            const answerPercentage = Math.round(
                (answeredCount / examData.totalQuestions) * 100
            );

            // به‌روزرسانی عناصر HTML
            document.getElementById("answered-count").textContent = answeredCount;
            document.getElementById("total-questions").textContent =
                examData.totalQuestions;
            document.getElementById("unanswered-count").textContent =
                unansweredCount;
            document.getElementById("time-spent").textContent = timeSpent;
            document.getElementById(
                "answer-percentage"
            ).textContent = `${answerPercentage}%`;
        }

        // تغییر تابع finishExam برای فراخوانی آمار
        function finishExam() {
            closeModal("finishModal");
            closeModal("timeoutModal");

            if (examData.timerInterval) {
                clearInterval(examData.timerInterval);
                examData.timerInterval = null;
            }

            // تولید کد پاسخ
            let answerCode = "";
            for (let i = 1; i <= examData.totalQuestions; i++) {
                answerCode += examData.answers[i] || "0";
            }

            // ذخیره پاسخ‌ها
            localStorage.setItem("studentAnswers", answerCode);

            // نمایش پاسخ‌های دانش‌آموز در فیلد مربوطه
            document.getElementById("student-answers").value = answerCode;

            // به‌روزرسانی آمار آزمون
            updateExamStats();

            showNotification(
                "آزمون با موفقیت به پایان رسید! پاسخ‌های شما ذخیره شد.",
                "success"
            );

            // رفتن به صفحه نتایج
            setTimeout(() => {
                showPage("result-page");
            }, 1000);
        }

        // رفتن به برگه‌یار
        function goToAnswerSheet() {
            // ذخیره اطلاعات برای انتقال به برگه‌یار
            localStorage.setItem("fromDigitalYar", "true");
            localStorage.setItem("studentAnswers", generateStudentAnswersString());
            localStorage.setItem(
                "examTotalQuestions",
                examData.totalQuestions.toString()
            );

            // انتقال به صفحه برگه‌یار
            window.location.href = "bargehyar2.html";
        }

        // اضافه کردن تابع اعتبارسنجی مختصات
        function validateCoordinates(x1, y1, x2, y2, pageHeight) {
            if (x1 !== 0) {
                console.warn("x1 باید همیشه 0 باشد، اما دریافت شد:", x1);
                x1 = 0;
            }

            if (x2 !== 3600) {
                console.warn("x2 باید همیشه 3600 باشد، اما دریافت شد:", x2);
                x2 = 3600;
            }

            if (y1 < 0) y1 = 0;
            if (y2 > pageHeight) y2 = pageHeight;
            if (y2 <= y1) y2 = y1 + 100; // حداقل ارتفاع

            return {
                x1,
                y1,
                x2,
                y2
            };
        }

        // تابع بهبود یافته برای رندر باکس‌های سوالات - بدون انیمیشن‌های مشکل‌ساز
        function renderQuestionBoxes() {
            const {
                userAnswers,
                correctAnswers,
                totalQuestions,
                subjectMap
            } = examData;
            const grid = document.getElementById("questionsGrid");
            grid.innerHTML = "";

            for (let i = 1; i <= totalQuestions; i++) {
                const index = i - 1;
                let status, userAnswer, correctAnswer, icon;

                if (userAnswers[index] === 0) {
                    status = "empty";
                    userAnswer = "-";
                    correctAnswer = correctAnswers[index];
                    icon = '<i class="far fa-circle status-icon"></i>';
                } else if (userAnswers[index] === correctAnswers[index]) {
                    status = "correct";
                    userAnswer = userAnswers[index];
                    correctAnswer = correctAnswers[index];
                    icon = '<i class="fas fa-check-circle status-icon"></i>';
                } else {
                    status = "wrong";
                    userAnswer = userAnswers[index];
                    correctAnswer = correctAnswers[index];
                    icon = '<i class="fas fa-times-circle status-icon"></i>';
                }

                const subject = subjectMap[i] || "نامشخص";

                const box = document.createElement("div");
                box.className = `question-box ${status}`;
                box.dataset.index = index;
                box.dataset.status = status;
                box.dataset.subject = subject;
                box.innerHTML = `
            ${icon}
            <div class="question-number">${i}</div>
            <div class="question-answer">${userAnswer}</div>
            <div class="question-key">✓${correctAnswer}</div>
        `;

                // اضافه کردن event listener ساده برای نمایش جزئیات
                box.addEventListener("click", function() {
                    showQuestionDetails(this.dataset.index);
                });

                grid.appendChild(box);
            }
        }

        // تابع بهبود یافته برای نمایش جزئیات سوال - بدون اسکرول مشکل‌ساز
        function showQuestionDetails(index) {
            const {
                userAnswers,
                correctAnswers,
                subjectMap
            } = examData;
            const questionNum = parseInt(index) + 1;
            const userAnswer = userAnswers[index];
            const correctAnswer = correctAnswers[index];
            const subject = subjectMap[questionNum] || "نامشخص";

            let status, statusText;
            if (userAnswer === 0) {
                status = "empty";
                statusText = "نزده";
            } else if (userAnswer === correctAnswer) {
                status = "correct";
                statusText = "صحیح";
            } else {
                status = "wrong";
                statusText = "غلط";
            }

            document.getElementById("detailNumber").textContent = questionNum;
            document.getElementById("detailStatus").textContent = statusText;
            document.getElementById("detailStatus").className = "detail-value " + status;
            document.getElementById("detailUserAnswer").textContent = userAnswer === 0 ? "-" : userAnswer;
            document.getElementById("detailCorrectAnswer").textContent = correctAnswer;
            document.getElementById("detailSubject").textContent = subject;

            // highlight سوال انتخاب شده
            document.querySelectorAll(".question-box").forEach((box) => {
                box.classList.remove("selected");
            });

            const selectedBox = document.querySelector(`.question-box[data-index="${index}"]`);
            if (selectedBox) {
                selectedBox.classList.add("selected");
            }
        }

        // تابع بهبود یافته برای فیلتر کردن سوالات - ساده‌سازی
        function filterQuestions(filter) {
            document.querySelectorAll(".question-box").forEach((box) => {
                if (filter === "all" || box.dataset.status === filter) {
                    box.style.display = "flex";
                } else {
                    box.style.display = "none";
                }
            });
        }

        // غیرفعال کردن انیمیشن‌های مشکل‌ساز در تابع enhanceAnimations
        function enhanceAnimations() {
            // فقط انیمیشن‌های ساده‌تر را نگه دارید
            const buttons = document.querySelectorAll(".btn");
            buttons.forEach((btn) => {
                btn.addEventListener("mouseenter", () => {
                    btn.style.transform = "translateY(-2px)";
                });

                btn.addEventListener("mouseleave", () => {
                    btn.style.transform = "";
                });
            });
        }

        // تابع برای پردازش مرحله‌ای صفحات
        async function processPagesInBatches(
            pdfDocument,
            jsonData,
            batchSize = 20
        ) {
            const totalPages = pdfDocument.numPages;
            const results = {};

            for (
                let startPage = 1; startPage <= totalPages; startPage += batchSize
            ) {
                const endPage = Math.min(startPage + batchSize - 1, totalPages);
                console.log(`پردازش صفحات ${startPage} تا ${endPage}`);

                // پردازش این دسته از صفحات
                const batchResults = await processPageBatch(
                    pdfDocument,
                    jsonData,
                    startPage,
                    endPage
                );
                Object.assign(results, batchResults);

                // اگر آخرین دسته نبود، منتظر تأیید برای ادامه باش
                if (endPage < totalPages) {
                    await new Promise((resolve) => {
                        if (
                            confirm(
                                `صفحات ${startPage} تا ${endPage} پردازش شد. ادامه دهیم؟`
                            )
                        ) {
                            resolve();
                        }
                    });
                }
            }

            return results;
        }

        // تابع جدید برای مقیاس‌بندی مختصات
        function scaleCoordinates(jsonData, targetWidth = 3600) {
            const scaleFactor = targetWidth / 7200;
            const scaledData = {};

            for (let page in jsonData) {
                scaledData[page] = jsonData[page].map((question) => {
                    return {
                        ...question,
                        x1: Math.round(question.x1 * scaleFactor),
                        x2: Math.round(question.x2 * scaleFactor),
                        y1: Math.round(question.y1 * scaleFactor),
                        y2: Math.round(question.y2 * scaleFactor),
                    };
                });
            }

            return scaledData;
        }

        // تابع validateCoordinates را با این نسخه جایگزین کنید
        function validateCoordinates(jsonData) {
            const validatedData = {};
            let hasWarning = false;

            for (let page in jsonData) {
                validatedData[page] = jsonData[page].map((question) => {
                    let {
                        x1,
                        y1,
                        x2,
                        y2
                    } = question;

                    // اعتبارسنجی و تصحیح مختصات
                    if (x1 < 0) x1 = 0;
                    if (y1 < 0) y1 = 0;
                    if (x2 < x1) {
                        console.warn(
                            `هشدار: x2 (${x2}) کوچکتر از x1 (${x1}) است برای سوال ${question.شماره} در صفحه ${page}`
                        );
                        x2 = x1 + 100;
                        hasWarning = true;
                    }
                    if (y2 <= y1) {
                        console.warn(
                            `هشدار: y2 (${y2}) باید بزرگتر از y1 (${y1}) باشد برای سوال ${question.شماره} در صفحه ${page}`
                        );
                        y2 = y1 + 100; // حداقل ارتفاع
                        hasWarning = true;
                    }

                    return {
                        ...question,
                        x1,
                        y1,
                        x2,
                        y2,
                    };
                });
            }

            if (hasWarning) {
                showNotification(
                    "هشدار: برخی مختصات نیاز به تنظیم داشتند. لطفاً نتایج را بررسی کنید.",
                    "warning"
                );
            }

            return validatedData;
        }

        // تابع برای پردازش مرحله‌ای صفحات
        async function processPagesInBatches(
            pdfDocument,
            jsonData,
            batchSize = 20
        ) {
            const totalPages = pdfDocument.numPages;
            const results = {};

            for (
                let startPage = 1; startPage <= totalPages; startPage += batchSize
            ) {
                const endPage = Math.min(startPage + batchSize - 1, totalPages);
                console.log(`پردازش صفحات ${startPage} تا ${endPage}`);

                // پردازش این دسته از صفحات
                const batchResults = await processPageBatch(
                    pdfDocument,
                    jsonData,
                    startPage,
                    endPage
                );
                Object.assign(results, batchResults);

                // اگر آخرین دسته نبود، منتظر تأیید برای ادامه باش
                if (endPage < totalPages) {
                    await new Promise((resolve) => {
                        if (
                            confirm(
                                `صفحات ${startPage} تا ${endPage} پردازش شد. ادامه دهیم؟`
                            )
                        ) {
                            resolve();
                        }
                    });
                }
            }

            return results;
        }

        // تابع انتقال به برگه‌یار (بهبود یافته)
        function goToAnswerSheet() {
            // تولید کد پاسخ
            let answerCode = "";
            for (let i = 1; i <= examData.totalQuestions; i++) {
                answerCode += examData.answers[i] || "0";
            }

            // ذخیره اطلاعات کامل برای انتقال به برگه‌یار
            const transferData = {
                fromDigitalYar: true,
                studentAnswers: answerCode,
                examTotalQuestions: examData.totalQuestions.toString(),
                examType: examData.examType ? examData.examType.toString() : "2",
                examName: examData.examName || "آزمون دستی",
                timestamp: new Date().toISOString()
            };

            // ذخیره در localStorage
            Object.keys(transferData).forEach(key => {
                localStorage.setItem(key, transferData[key]);
            });

            // نمایش اطلاعات انتقال
            console.log("اطلاعات انتقال به برگه‌یار:", transferData);

            showNotification('در حال انتقال به برگه‌یار...', 'info');

            // انتقال به صفحه برگه‌یار
            setTimeout(() => {
                window.location.href = "bargehyar2.html";
            }, 1500);
        }

        // توابع جدید برای آکاردئون و بخش‌های مخفی
        function toggleAccordion(accordionId) {
            const accordion = document.getElementById(accordionId);
            accordion.classList.toggle('active');
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const button = event.target.closest('.toggle-section-btn');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> مخفی کردن';
            } else {
                section.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> نمایش';
            }
        }

        // تابع کپی کلید آزمون
        function copyExamKey() {
            const examKey = document.getElementById('exam-key').value;

            if (!examKey) {
                showNotification('لطفاً ابتدا کلید آزمون را وارد کنید.', 'error');
                return;
            }

            navigator.clipboard.writeText(examKey)
                .then(() => {
                    showNotification('کلید آزمون با موفقیت کپی شد!');
                })
                .catch((err) => {
                    showNotification('خطا در کپی کلید آزمون: ' + err.message, 'error');
                });
        }

        // تابع کپی پرامپت کلید (اضافه کردن به prompts)
        function copyPrompt(type) {
            // اضافه کردن پرامپت کلید به آبجکت prompts
            const prompts = {
                json: `فایل PDF یا تصویر پیوست‌شده حاوی سوالات آزمون است...`, // پرامپت قبلی
                key: `۲. پردازش پاسخنامه تشریحی (کلید آزمون):
- پاسخ‌های صحیح را از پاسخنامه استخراج کن
- اطلاعات زیر را تشخیص بده:
  * تعداد سوالات واقعی
  * نام هر درس
  * نوع درس (فقط "عمومی" یا "تخصصی")
  * بازه سوالات هر درس
  * مباحث درسی (برای دروس تخصصی)
در نهایت اول کلید و بعد اطلاعات را با یک خط فاصله به کاربر میدی در اطلاعات هم هر چیزی که هست چه درس چه تاریخ با یک خط فاصله ارسال میشود
فرمت خروجی دقیق:
[پاسخ‌های صحیح]total_questions:[عدد]|subject:[نام درس]|type:[نوع]|start:[شروع]|end:[پایان]|chapters:[مباحث]

مثال خروجی:
1234213421...total_questions:250|subject:زبان|type:عمومی|start:1|end:30|subject:ریاضی|type:تخصصی|start:31|end:120|chapters:1,2,3

---

قوانین سخت‌گیرانه:
✅ فقط داده‌های خام برگردان
✅ هیچ متن اضافی ننویس
✅ از فرمت دقیقاً پیروی کن
✅ فقط اعداد انگلیسی استفاده کن
✅ فیلدها با | جدا شوند
✅ نوع درس فقط "عمومی" یا "تخصصی" است
✅ chapters فقط برای دروس تخصصی
✅ طول رشته پاسخ‌ها = تعداد سوالات`
            };

            navigator.clipboard.writeText(prompts[type])
                .then(() => {
                    showNotification(`پرامپت ${type === 'json' ? 'JSON برش' : 'کلید آزمون'} با موفقیت کپی شد!`);
                })
                .catch((err) => {
                    showNotification(`خطا در کپی پرامپت: ${err.message
                    }`, 'error');
                });
        }

        // بارگذاری اولیه - مخفی کردن بخش‌ها
        document.addEventListener('DOMContentLoaded', function() {
            // مخفی کردن بخش برش سوالات در ابتدا
            const slicingSection = document.getElementById('question-slicing-section');
            if (slicingSection) {
                slicingSection.style.display = 'none';
            }
        });

        // اضافه کردن این تابع به بخش JavaScript
        function pasteExamKey() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('exam-key').value = text;
                    showNotification('محتوا با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        // جایگزین کردن تابع toggleAccordion با این نسخه
        function toggleAccordion(accordionId) {
            const accordionContent = document.getElementById(accordionId);
            const accordionSection = accordionContent.parentElement;
            const accordionIcon = accordionSection.querySelector('.accordion-icon i');

            if (accordionSection.classList.contains('active')) {
                accordionSection.classList.remove('active');
                accordionIcon.classList.remove('fa-chevron-up');
                accordionIcon.classList.add('fa-chevron-down');
            } else {
                accordionSection.classList.add('active');
                accordionIcon.classList.remove('fa-chevron-down');
                accordionIcon.classList.add('fa-chevron-up');
            }
        }

        // بارگذاری اولیه - بستن آکاردئون
        document.addEventListener('DOMContentLoaded', function() {
            const accordion = document.querySelector('.accordion-section');
            if (accordion) {
                accordion.classList.remove('active');
            }
        });

        // اضافه کردن این تابع به بخش JavaScript
        function toggleSlicingSection() {
            const slicingSection = document.getElementById('question-slicing-section');
            const toggleButton = document.querySelector('.toggle-slicing-btn');

            if (slicingSection.style.display === 'none' || slicingSection.style.display === '') {
                slicingSection.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> مخفی کردن برش سوالات';
            } else {
                slicingSection.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> نمایش برش سوالات';
            }
        } // اضافه کردن این تابع به بخش JavaScript
        function toggleSlicingSection() {
            const slicingSection = document.getElementById('question-slicing-section');
            const toggleButton = document.querySelector('.toggle-slicing-btn');

            if (slicingSection.style.display === 'none' || slicingSection.style.display === '') {
                slicingSection.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> مخفی کردن برش سوالات';
            } else {
                slicingSection.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> نمایش برش سوالات';
            }
        }

        // تابع برای نمایش/مخفی کردن بخش برش سوالات
        function toggleSlicingSection() {
            const slicingSection = document.getElementById('question-slicing-section');
            const toggleButton = document.querySelector('.toggle-slicing-btn');
            const jsonWarning = document.getElementById('json-warning');

            if (slicingSection.style.display === 'none' || slicingSection.style.display === '') {
                slicingSection.style.display = 'block';
                jsonWarning.style.display = 'block'; // نمایش تذکر
                toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i> مخفی کردن برش سوالات';
            } else {
                slicingSection.style.display = 'none';
                jsonWarning.style.display = 'none'; // مخفی کردن تذکر
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i> نمایش برش سوالات';
            }
        }

        // تابع بهبود یافته برای کپی کلید آزمون
        function copyExamKey() {
            const examKey = document.getElementById('exam-key').value;

            if (!examKey) {
                showNotification('لطفاً ابتدا کلید آزمون را وارد کنید.', 'error');
                return;
            }

            navigator.clipboard.writeText(examKey)
                .then(() => {
                    showNotification('کلید آزمون با موفقیت کپی شد!', 'success');

                    // افکت بصری برای کادر کپی
                    const copyBox = document.querySelector('.copy-key-box');
                    copyBox.style.background = 'var(--success-color)';
                    setTimeout(() => {
                        copyBox.style.background = 'var(--gradient-primary)';
                    }, 1000);
                })
                .catch((err) => {
                    showNotification('خطا در کپی کلید آزمون: ' + err.message, 'error');
                });
        }

        // تابع برای کپی پرامپت کلید آزمون
        function copyPrompt(type) {
            const prompts = {
                json: `فایل PDF یا تصویر پیوست‌شده حاوی سوالات آزمون است...`, // پرامپت قبلی
                key: `۲. پردازش پاسخنامه تشریحی (کلید آزمون):
- پاسخ‌های صحیح را از پاسخنامه استخراج کن
- اطلاعات زیر را تشخیص بده:
  * تعداد سوالات واقعی
  * نام هر درس
  * نوع درس (فقط "عمومی" یا "تخصصی")
  * بازه سوالات هر درس
  * مباحث درسی (برای دروس تخصصی)
در نهایت اول کلید و بعد اطلاعات را با یک خط فاصله به کاربر میدی در اطلاعات هم هر چیزی که هست چه درس چه تاریخ با یک خط فاصله ارسال میشود
فرمت خروجی دقیق:
[پاسخ‌های صحیح]total_questions:[عدد]|subject:[نام درس]|type:[نوع]|start:[شروع]|end:[پایان]|chapters:[مباحث]

مثال خروجی:
1234213421...total_questions:250|subject:زبان|type:عمومی|start:1|end:30|subject:ریاضی|type:تخصصی|start:31|end:120|chapters:1,2,3

---

قوانین سخت‌گیرانه:
✅ فقط داده‌های خام برگردان
✅ هیچ متن اضافی ننویس
✅ از فرمت دقیقاً پیروی کن
✅ فقط اعداد انگلیسی استفاده کن
✅ فیلدها با | جدا شوند
✅ نوع درس فقط "عمومی" یا "تخصصی" است
✅ chapters فقط برای دروس تخصصی
✅ طول رشته پاسخ‌ها = تعداد سوالات`
            };

            navigator.clipboard.writeText(prompts[type])
                .then(() => {
                    showNotification(`پرامپت ${type === 'json' ? 'JSON برش' : 'کلید آزمون'} با موفقیت کپی شد!`, 'success');
                })
                .catch((err) => {
                    showNotification(`خطا در کپی پرامپت: ${err.message}`, 'error');
                });
        }

        // تابع برای تشخیص نوع دستگاه
        function detectDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /mobile|android|iphone|ipad|ipod|windows phone/i.test(userAgent);
            const isTablet = /ipad|tablet|playbook|silk/i.test(userAgent) ||
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

            if (isMobile) {
                return 'mobile';
            } else if (isTablet) {
                return 'tablet';
            } else {
                return 'desktop';
            }
        }

        // تابع برای اعمال استایل بر اساس نوع دستگاه
        function applyDeviceSpecificStyles() {
            const deviceType = detectDeviceType();
            const container = document.querySelector('.container');
            const body = document.body;

            // حذف کلاس‌های قبلی
            body.classList.remove('mobile-view', 'desktop-view', 'tablet-view');
            container.classList.remove('mobile-container', 'desktop-container', 'tablet-container');

            // اضافه کردن کلاس‌های جدید
            if (deviceType === 'mobile') {
                body.classList.add('mobile-view');
                container.classList.add('mobile-container');
                console.log('حالت موبایل فعال شد');
            } else {
                body.classList.add('desktop-view');
                container.classList.add('desktop-container');
                console.log('حالت دسکتاپ/تبلت فعال شد');
            }
        }

        // اعمال استایل‌ها هنگام بارگذاری صفحه
        window.addEventListener('DOMContentLoaded', function() {
            applyDeviceSpecificStyles();
        });

        // اعمال استایل‌ها هنگام تغییر سایز پنجره
        window.addEventListener('resize', function() {
            applyDeviceSpecificStyles();
        });

        // تابع برای کپی کلید آزمون
        function copyExamKey() {
            const examKey = document.getElementById('exam-key').value;

            if (!examKey) {
                showNotification('لطفاً ابتدا کلید آزمون را وارد کنید.', 'error');
                return;
            }

            navigator.clipboard.writeText(examKey)
                .then(() => {
                    showNotification('کلید آزمون با موفقیت کپی شد!', 'success');
                })
                .catch((err) => {
                    showNotification('خطا در کپی کلید آزمون: ' + err.message, 'error');
                });
        }

        // تابع برای پیست کلید آزمون
        function pasteExamKey() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('exam-key').value = text;
                    showNotification('محتوا با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        // تابع برای پیست کردن محتوا در فیلد کلید آزمون
        function pasteToExamKey() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('exam-key').value = text;
                    showNotification('کلید آزمون با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        // تابع برای پیست کردن محتوا در فیلد JSON
        function pasteToJsonField() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('json-code').value = text;
                    showNotification('کد JSON با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        // تابع کپی پرامپت با متن راهنما
        function copyPrompt(type) {
            const prompts = {
                json: `فایل PDF یا تصویر پیوست‌شده حاوی سوالات آزمون است. لطفاً فقط صفحات دارای سوالات شماره‌گذاری‌شده (مانند ۱، ۲، ۳، ۴، ۵، ۶، ۷، ۸، ۹، ۱۰ و غیره با استفاده از اعداد فارسی) را پردازش کن و صفحات بدون شماره سوال (مانند صفحه کاور، صفحات حاوی اطلاعات آزمون، صفحات خالی، پاسخ‌برگ‌ها، یا هر صفحه‌ای که فاقد ستون عمودی شماره سوالات است) را کاملاً نادیده بگیر. شماره سوالات همیشه به صورت اعداد فارسی (۱، ۲، ۳...) در یک ستون عمودی در سمت راست‌ترین قسمت صفحه (یعنی راست‌ترین ستون اعداد، معمولاً نزدیک حاشیه راست صفحه) قرار دارند. این ستون معمولاً شامل شماره‌های متوالی است و ممکن است با خطوط افقی یا عمودی جدا شده باشد.

برای دستیابی به بیشترین دقت در برش، از ابزارهای تحلیل تصویر پیشرفته استفاده کن. مرزهای هر سوال را با دقت پیکسلی شناسایی کن: y1 را دقیقاً از پیکسل شروع بالاترین عنصر و y2 را دقیقاً تا پیکسل پایان پایین‌ترین عنصر تنظیم کن، بدون هیچ هم‌پوشانی یا فاصله اضافی.

فرض کن DPI = ۶۰۰ برای تبدیل PDF به تصویر، و عرض صفحه دقیقاً ۳۶۰۰ پیکسل است.

خروجی باید فقط JSON باشد با فرمت دقیق زیر:

{
  "صفحه_X": [
    { "شماره": "N", "x1": 0, "y1": Y1, "x2": 3600, "y2": Y2 }
  ]
}

که در آن:
- X شماره صفحه واقعی در PDF است
- N شماره سوال است (به صورت رشته با اعداد فارسی)
- Y1 و Y2 مختصات عمودی بر حسب پیکسل هستند

لطفاً فقط کد JSON خالص بدون هیچ متن اضافی تولید کن.`,

                key: `۲. پردازش پاسخنامه تشریحی (کلید آزمون):
- پاسخ‌های صحیح را از پاسخنامه استخراج کن
- اطلاعات زیر را تشخیص بده:
  * تعداد سوالات واقعی
  * نام هر درس
  * نوع درس (فقط "عمومی" یا "تخصصی")
  * بازه سوالات هر درس
  * مباحث درسی (برای دروس تخصصی)
در نهایت اول کلید و بعد اطلاعات را با یک خط فاصله به کاربر میدی در اطلاعات هم هر چیزی که هست چه درس چه تاریخ با یک خط فاصله ارسال میشود
فرمت خروجی دقیق:
[پاسخ‌های صحیح]total_questions:[عدد]|subject:[نام درس]|type:[نوع]|start:[شروع]|end:[پایان]|chapters:[مباحث]

مثال خروجی:
1234213421...total_questions:250|subject:زبان|type:عمومی|start:1|end:30|subject:ریاضی|type:تخصصی|start:31|end:120|chapters:1,2,3

---

قوانین سخت‌گیرانه:
✅ فقط داده‌های خام برگردان
✅ هیچ متن اضافی ننویس
✅ از فرمت دقیقاً پیروی کن
✅ فقط اعداد انگلیسی استفاده کن
✅ فیلدها با | جدا شوند
✅ نوع درس فقط "عمومی" یا "تخصصی" است
✅ chapters فقط برای دروس تخصصی
✅ طول رشته پاسخ‌ها = تعداد سوالات`
            };

            navigator.clipboard.writeText(prompts[type])
                .then(() => {
                    const promptName = type === 'json' ? 'JSON برش' : 'کلید آزمون';
                    showNotification(`پرامپت ${promptName} کپی شد! حالا آن را برای هوش مصنوعی خارجی ارسال کنید.`, 'success');
                })
                .catch((err) => {
                    showNotification(`خطا در کپی پرامپت: ${err.message}`, 'error');
                });
        }

        function copyPrompt(type) {
            const prompts = {
                json: jsonPrompt,
                key: keyPrompt
            };

            navigator.clipboard.writeText(prompts[type])
                .then(() => {
                    const promptName = type === 'json' ? 'JSON برش' : 'کلید آزمون';
                    showNotification(`پرامپت ${promptName} کپی شد!`, 'success');
                })
                .catch((err) => {
                    showNotification(`خطا در کپی پرامپت: ${err.message}`, 'error');
                });
        }

        function pasteToExamKey() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('exam-key').value = text;
                    showNotification('کلید آزمون با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        function pasteToJsonField() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('json-code').value = text;
                    showNotification('کد JSON با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }
        // تابع برای پیست کردن محتوا در فیلد JSON
        function pasteToJsonField() {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById('json-code').value = text;
                    showNotification('کد JSON با موفقیت پیست شد!', 'success');
                })
                .catch(err => {
                    showNotification('خطا در خواندن clipboard: ' + err.message, 'error');
                });
        }

        // تابع تشخیص خودکار نوع آزمون
        function detectExamType() {
            const fileInput = document.getElementById('file-upload');
            const examKey = document.getElementById('exam-key').value.trim();
            const jsonCode = document.getElementById('json-code').value.trim();

            const hasFile = fileInput.files.length > 0;
            const hasExamKey = examKey.length > 0;
            const hasJson = jsonCode.length > 0;

            if (hasFile && hasExamKey && hasJson) {
                return 2; // نوع 2: دارای JSON
            } else if (hasFile && hasExamKey) {
                return 1; // نوع 1: بدون JSON
            } else {
                return 0; // اطلاعات ناقص
            }
        }

        // تابع ایجاد آزمون (اصلاح شده)
        async function createExam() {
            const examType = detectExamType();

            if (examType === 0) {
                showNotification('لطفاً فایل سوالات و کلید آزمون را وارد کنید.', 'error');
                return;
            }

            if (examType === 1) {
                await createType1Exam(); // آزمون نوع 1
            } else if (examType === 2) {
                await createType2Exam(); // آزمون نوع 2 (همان آزمون فعلی)
            }
        }

        // تابع ایجاد آزمون نوع 1 (اصلاح شده)
        async function createType1Exam() {
            const fileInput = document.getElementById('file-upload');
            const pdfFile = fileInput.files[0];
            const examKey = document.getElementById('exam-key').value.trim();

            if (!pdfFile || !examKey) {
                showNotification('لطفاً فایل سوالات و کلید آزمون را وارد کنید.', 'error');
                return;
            }

            try {
                // بارگذاری PDF
                await loadPDF(pdfFile);

                // استخراج تعداد سوالات از کلید آزمون
                const totalQuestions = extractTotalQuestionsFromKey(examKey);

                if (!totalQuestions) {
                    showNotification('خطا در استخراج تعداد سوالات از کلید آزمون.', 'error');
                    return;
                }

                // ذخیره اطلاعات آزمون
                examData.totalQuestions = totalQuestions;
                examData.timeRemaining = parseInt(document.getElementById('timer-input').value) * 60;
                examData.examName = pdfFile.name;
                examData.answers = {};
                examData.currentPage = 1;
                examData.examStarted = false;
                examData.examType = 1;
                examData.pdfFile = pdfFile;

                // ایجاد صفحه آزمون نوع 1 فول‌اسکرین با طرح جدید
                createType1ExamPage();

            } catch (error) {
                showNotification('خطا در ایجاد آزمون: ' + error.message, 'error');
            }
        }

        // تابع استخراج تعداد سوالات از کلید آزمون
        function extractTotalQuestionsFromKey(examKey) {
            try {
                // جستجوی الگوی total_questions در کلید
                const match = examKey.match(/total_questions:(\d+)/);
                if (match && match[1]) {
                    return parseInt(match[1]);
                }

                // اگر الگو پیدا نشد، طول رشته پاسخ‌ها را بررسی کن
                const answersMatch = examKey.match(/^[12345]+/);
                if (answersMatch) {
                    return answersMatch[0].length;
                }

                return null;
            } catch (error) {
                console.error('خطا در استخراج تعداد سوالات:', error);
                return null;
            }
        }

        // تابع ایجاد صفحه آزمون نوع 1
        function createType1ExamPage() {
            const examPage = document.getElementById('manual-exam-page');

            // پاک کردن محتوای قبلی
            examPage.innerHTML = '';

            // ساختار صفحه آزمون نوع 1
            examPage.innerHTML = `
        <div class="form-container">
            <div class="exam-header">
                <h3 class="exam-title" id="exam-name">${examData.examName}</h3>
                <div class="timer-container">
                    <div class="timer" id="exam-timer">${formatTime(examData.timeRemaining)}</div>
                    <button class="btn btn-primary" id="start-exam-btn" onclick="startExam()">
                        <i class="fas fa-play"></i> شروع آزمون
                    </button>
                    <button class="toggle-timer" id="hide-timer-btn" onclick="toggleTimerVisibility()">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>

            <div class="type1-exam-layout">
                <div class="pdf-viewer-container">
                    <div class="pdf-controls">
                        <button class="btn btn-secondary" onclick="changePDFPage(-1)">
                            <i class="fas fa-arrow-right"></i> صفحه قبل
                        </button>
                        <span class="page-info">صفحه <span id="current-page">1</span> از <span id="total-pages">1</span></span>
                        <button class="btn btn-secondary" onclick="changePDFPage(1)">
                            صفحه بعد <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    <div class="pdf-viewer">
                        <img id="pdf-page-image" class="pdf-page-image" alt="صفحه PDF" onclick="zoomPDFImage(this.src)">
                    </div>
                </div>

                <div class="questions-sidebar">
    <div class="sidebar-header-improved">
        <div class="exam-info-top">
            <button class="btn btn-primary" id="start-exam-btn" onclick="startExamFullscreen()" style="width: 100%; margin-bottom: 10px;">
                <i class="fas fa-play"></i> شروع آزمون
            </button>
            <div class="header-timer">
                <i class="fas fa-clock"></i>
                <span id="exam-timer-header">${formatTime(examData.timeRemaining)}</span>
            </div>
        </div>
        <div class="questions-header">
            <h4>سوالات آزمون</h4>
            <div class="questions-count">${examData.totalQuestions} سوال</div>
        </div>
    </div>
    
    <div class="questions-column" id="questions-column">
        <!-- سوالات اینجا ساخته می‌شوند -->
    </div>
    
    <div class="exam-actions-sidebar">
        <button class="btn btn-success" onclick="confirmFinishExam()" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-flag-checkered"></i> پایان آزمون
        </button>
    </div>
</div>
    `;

            // بارگذاری اولین صفحه PDF
            loadPDFPage(1);

            // ایجاد لیست سوالات
            createQuestionsList();

            // نمایش صفحه
            showPage('manual-exam-page');
        }

        // تابع بارگذاری صفحه PDF (بهبود یافته)
        async function loadPDFPage(pageNumber) {
            try {
                if (!pdfDocument) {
                    await loadPDF(examData.pdfFile);
                }

                const totalPages = pdfDocument.numPages;

                // نمایش loading ساده
                const pdfImage = document.getElementById('pdf-page-image');
                pdfImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIiBmaWxsPSIjOTk5Ij5Mb2FkaW5nLi4uPC90ZXh0Pjwvc3ZnPg==';

                const pageImage = await renderPDFPage(pageNumber, 2);
                pdfImage.src = pageImage;

                examData.currentPDFPage = pageNumber;

            } catch (error) {
                console.error('خطا در بارگذاری صفحه PDF:', error);

                // نمایش تصویر جایگزین ساده
                const pdfImage = document.getElementById('pdf-page-image');
                pdfImage.src = `https://via.placeholder.com/800x1000/1b9aaa/ffffff?text=خطا+در+بارگذاری+صفحه+${pageNumber}`;
            }
        }

        // اضافه کردن کنترل‌های صفحه‌بندی به exam-controls-fullscreen
        function updateFullscreenControls() {
            const examControls = document.querySelector('.exam-controls-fullscreen');
            if (examControls && pdfDocument) {
                examControls.innerHTML = `
            <button class="btn btn-info" onclick="changePDFPage(-1)" title="صفحه قبل">
                <i class="fas fa-arrow-right"></i>
            </button>
            <button class="btn btn-info" onclick="changePDFPage(1)" title="صفحه بعد">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="btn btn-info" onclick="scrollToQuestionColumn(1)" title="برو به سوال اول">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button class="btn btn-info" onclick="scrollToQuestionColumn(examData.totalQuestions)" title="برو به سوال آخر">
                <i class="fas fa-arrow-down"></i>
            </button>
            <button class="btn btn-info" onclick="toggleTimerVisibilityFullscreen()" title="مخفی/نمایش تایمر">
                <i class="fas fa-eye-slash"></i>
            </button>
        `;
            }
        }

        // فراخوانی این تابع پس از ایجاد صفحه فول‌اسکرین
        function createType1ExamPage() {
            // ... کدهای قبلی

            // بعد از بارگذاری PDF
            setTimeout(() => {
                updateFullscreenControls();
            }, 1000);
        }

        // تابع تغییر صفحه PDF (اصلاح شده)
        async function changePDFPage(direction) {
            if (!pdfDocument) {
                showNotification('PDF بارگذاری نشده است', 'error');
                return;
            }

            const newPage = examData.currentPDFPage + direction;
            const totalPages = pdfDocument.numPages;

            if (newPage >= 1 && newPage <= totalPages) {
                await loadPDFPage(newPage);

                // نمایش نوتیفیکیشن برای تغییر صفحه
                showNotification(`صفحه ${newPage} از ${totalPages}`, 'info');

                // به روزرسانی وضعیت سوالات مربوط به این صفحه (اختیاری)
                updateQuestionsForPage(newPage);
            } else {
                showNotification(`صفحه ${newPage} وجود ندارد`, 'warning');
            }
        }

        // تابع ایجاد لیست سوالات
        function createQuestionsList() {
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = '';

            for (let i = 1; i <= examData.totalQuestions; i++) {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.id = `question-item-${i}`;
                questionItem.onclick = () => selectQuestion(i);

                // ایجاد گزینه‌ها
                let optionsHTML = '';
                for (let j = 1; j <= examData.optionsCount; j++) {
                    optionsHTML += `<div class="option-square" data-option="${j}">${j}</div>`;
                }

                questionItem.innerHTML = `
            <div class="question-number">سوال ${i}</div>
            <div class="question-options">${optionsHTML}</div>
        `;

                questionsList.appendChild(questionItem);

                // اضافه کردن event listener به گزینه‌ها
                questionItem.querySelectorAll('.option-square').forEach(option => {
                    option.onclick = (e) => {
                        e.stopPropagation(); // جلوگیری از اجرای رویداد والد
                        selectOptionForQuestion(i, parseInt(option.getAttribute('data-option')));
                    };
                });

                // اگر پاسخ قبلی وجود دارد، آن را نمایش بده
                if (examData.answers[i]) {
                    updateQuestionItemDisplay(i, examData.answers[i]);
                }
            }
        }



        // تابع انتخاب سوال
        function selectQuestion(questionNumber) {
            // هایلایت سوال انتخاب شده
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`question-item-${questionNumber}`).classList.add('active');

            // اسکرول به سوال انتخاب شده
            document.getElementById(`question-item-${questionNumber}`).scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // تابع به روزرسانی نمایش سوال
        function updateQuestionItemDisplay(questionNumber, optionNumber) {
            const questionItem = document.getElementById(`question-item-${questionNumber}`);
            if (!questionItem) return;

            // علامت‌گذاری سوال پاسخ داده شده
            questionItem.classList.add('answered');

            // هایلایت گزینه انتخاب شده
            questionItem.querySelectorAll('.option-square').forEach(option => {
                option.classList.remove('selected');
                if (parseInt(option.getAttribute('data-option')) === optionNumber) {
                    option.classList.add('selected');
                }
            });
        }

        // تابع انتخاب گزینه برای سوال
        function selectOptionForQuestion(questionNumber, optionNumber) {
            if (!examData.examStarted) {
                showNotification('لطفاً ابتدا آزمون را شروع کنید!', 'error');
                return;
            }

            // اگر گزینه قبلاً انتخاب شده بود، آن را حذف کن
            if (examData.answers[questionNumber] === optionNumber) {
                examData.answers[questionNumber] = null;
                showNotification(`پاسخ سوال ${questionNumber} حذف شد`, 'info');
            } else {
                // در غیر این صورت، گزینه جدید را انتخاب کن
                examData.answers[questionNumber] = optionNumber;
                showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, 'success');
            }

            // به روزرسانی نمایش
            updateQuestionItemDisplay(questionNumber, examData.answers[questionNumber]);
        }

        // تابع فرمت زمان
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // تابع زوم تصویر PDF
        function zoomPDFImage(imageSrc) {
            // استفاده از تابع زوم موجود
            zoomQuestionImage(imageSrc);
        }

        // تابع createExam اصلی (اصلاح شده)
        async function createExam() {
            const examType = detectExamType();

            if (examType === 0) {
                showNotification('لطفاً فایل سوالات و کلید آزمون را وارد کنید.', 'error');
                return;
            }

            showNotification('در حال ایجاد آزمون...', 'info');

            if (examType === 1) {
                await createType1Exam(); // آزمون نوع 1
            } else if (examType === 2) {
                await createType2Exam(); // آزمون نوع 2
            }
        }

        // تابع createType2Exam (آزمون فعلی)
        async function createType2Exam() {
            // کد فعلی شما برای ایجاد آزمون نوع 2
            const jsonCode = document.getElementById('json-code').value.trim();
            const fileInput = document.getElementById('file-upload');
            const pdfFile = fileInput.files[0];

            if (!jsonCode) {
                showNotification('لطفاً کد JSON را وارد کنید.', 'error');
                return;
            }

            if (!pdfFile) {
                showNotification('لطفاً فایل PDF سوالات را آپلود کنید.', 'error');
                return;
            }

            try {
                // پردازش و پاکسازی JSON
                const jsonData = cleanAndParseJSON(jsonCode);

                // تشخیص و مقیاس‌بندی خودکار مختصات
                const scaledData = detectAndScaleCoordinates(jsonData);

                // اعتبارسنجی مختصات
                const validatedData = validateCoordinates(scaledData);

                // پردازش سوالات از JSON
                const questions = await processQuestionsFromJSON(validatedData, pdfFile, false);

                examData.totalQuestions = questions.length;
                examData.timeRemaining = parseInt(document.getElementById('timer-input').value) * 60;
                examData.questions = questions;
                examData.answers = {};
                examData.currentPage = 1;
                examData.examStarted = false;
                examData.examType = 2; // نوع آزمون 2

                // نمایش نام آزمون
                document.getElementById('exam-name').textContent = examData.examName;

                // نمایش سوالات
                displayQuestions();

                // ایجاد نوار وضعیت
                createProgressBar();

                // ایجاد صفحه‌بندی
                createPagination();

                // رفتن به صفحه آزمون
                showPage('manual-exam-page');

                showNotification(`آزمون نوع 2 با ${examData.totalQuestions} سوال ایجاد شد!`, 'success');

            } catch (error) {
                showNotification('خطا در پردازش: ' + error.message, 'error');
            }
        }

        function createType1ExamPage() {
            // مخفی کردن container اصلی
            document.querySelector('.container').style.display = 'none';

            // ایجاد المان فول‌اسکرین
            const fullscreenExam = document.createElement('div');
            fullscreenExam.className = 'type1-exam-fullscreen';
            fullscreenExam.id = 'type1-exam-fullscreen';
            fullscreenExam.tabIndex = 0;

            // ساختار ساده‌شده صفحه آزمون
            fullscreenExam.innerHTML = `
        <div class="pdf-viewer-container">
            <div class="pdf-viewer">
                <img id="pdf-page-image" class="pdf-page-image" alt="صفحه PDF" onclick="zoomPDFImage(this.src)">
            </div>
        </div>

        <div class="questions-sidebar">
            <div class="sidebar-header-improved">
                <div class="questions-header">
                    <h4>سوالات آزمون</h4>
                    <div class="questions-count">${examData.totalQuestions} سوال</div>
                </div>
            </div>
            
            <div class="questions-column" id="questions-column">
                <!-- سوالات اینجا ساخته می‌شوند -->
            </div>
            
            <div class="exam-actions-sidebar">
                <button class="btn btn-primary" id="start-exam-btn" onclick="startExamFullscreen()" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-play"></i> شروع آزمون
                </button>
                <button class="btn btn-success" onclick="confirmFinishExam()" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-flag-checkered"></i> پایان آزمون
                </button>
            </div>
        </div>
    `;

            // اضافه کردن به body
            document.body.appendChild(fullscreenExam);
            fullscreenExam.focus();

            // غیرفعال کردن اسکرول body
            document.body.style.overflow = 'hidden';

            // بارگذاری اولین صفحه PDF
            loadPDFPage(1);

            // ایجاد لیست سوالات به صورت ستونی
            createQuestionsColumn();

            // نمایش صفحه
            showNotification('آزمون نوع ۱ در حالت فول‌اسکرین بارگذاری شد!', 'success');
        }

        // تابع ایجاد لیست سوالات به صورت عمودی با گزینه‌های عمودی
        function createQuestionsListVertical() {
            const questionsList = document.getElementById('questions-list');
            questionsList.innerHTML = '';

            for (let i = 1; i <= examData.totalQuestions; i++) {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item';
                questionItem.id = `question-item-${i}`;

                // ایجاد گزینه‌ها به صورت عمودی
                let optionsHTML = '';
                const optionLetters = ['۱', '۲', '۳', '۴', '۵'];

                for (let j = 0; j < examData.optionsCount; j++) {
                    optionsHTML += `
                <div class="option-item-vertical" onclick="event.stopPropagation(); selectOptionForQuestion(${i}, ${j + 1})">
                    <div class="option-marker">${optionLetters[j]}</div>
                    <span>گزینه ${j + 1}</span>
                </div>
            `;
                }

                questionItem.innerHTML = `
            <div class="question-header" onclick="selectQuestion(${i})">
                <div class="question-number">سوال ${i}</div>
                <div class="question-status" id="status-${i}">
                    <i class="fas fa-circle" style="color: var(--border-color); font-size: 12px;"></i>
                </div>
            </div>
            <div class="question-options-vertical">
                ${optionsHTML}
            </div>
        `;

                questionsList.appendChild(questionItem);

                // اگر پاسخ قبلی وجود دارد، آن را نمایش بده
                if (examData.answers[i]) {
                    updateQuestionItemDisplay(i, examData.answers[i]);
                }
            }
        }

        // تابع انتخاب سوال و اسکرول به آن
        function selectQuestion(questionNumber) {
            // هایلایت سوال انتخاب شده
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
            });

            const selectedItem = document.getElementById(`question-item-${questionNumber}`);
            if (selectedItem) {
                selectedItem.classList.add('active');

                // اسکرول به سوال انتخاب شده
                selectedItem.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // تابع اسکرول به سوال خاص
        function scrollToQuestion(questionNumber) {
            selectQuestion(questionNumber);
        }

        // تابع خروج از حالت فول‌اسکرین
        function exitFullscreen() {
            const fullscreenExam = document.getElementById('type1-exam-fullscreen');
            if (fullscreenExam) {
                document.body.removeChild(fullscreenExam);
                document.querySelector('.container').style.display = 'block';
                document.body.style.overflow = 'auto';

                // برگشت به صفحه اصلی
                showPage('manual-exam');
            }
        }

        // تابع زوم تصویر PDF (بهبود یافته)
        function zoomPDFImage(imageSrc) {
            // غیرفعال کردن اسکرول صفحه
            document.body.style.overflow = 'hidden';

            // ایجاد مودال زوم
            const zoomModal = document.createElement('div');
            zoomModal.className = 'image-zoom-modal active';
            zoomModal.style.zIndex = '10002';
            zoomModal.innerHTML = `
        <span class="close-zoom" onclick="closePDFZoom()">&times;</span>
        <div class="zoomed-image-container">
            <img class="zoomed-image" src="${imageSrc}" alt="تصویر سوال" 
                 onclick="event.stopPropagation()">
        </div>
    `;

            // بستن مودال با کلیک روی پس‌زمینه
            zoomModal.onclick = function(e) {
                if (e.target === zoomModal) {
                    closePDFZoom();
                }
            };

            document.body.appendChild(zoomModal);
        }

        // تابع بستن زوم PDF
        function closePDFZoom() {
            const zoomModal = document.querySelector('.image-zoom-modal');
            if (zoomModal) {
                document.body.removeChild(zoomModal);
                document.body.style.overflow = 'hidden'; // همچنان فول‌اسکرین هستیم
            }
        }

        // تابع به روزرسانی نمایش سوال
        function updateQuestionItemDisplay(questionNumber, optionNumber) {
            const questionItem = document.getElementById(`question-item-${questionNumber}`);
            if (!questionItem) return;

            // علامت‌گذاری سوال پاسخ داده شده
            questionItem.classList.add('answered');

            // به روزرسانی وضعیت
            const statusIcon = document.getElementById(`status-${questionNumber}`);
            if (statusIcon) {
                statusIcon.innerHTML = '<i class="fas fa-check-circle" style="color: var(--success-color);"></i>';
            }

            // هایلایت گزینه انتخاب شده
            questionItem.querySelectorAll('.option-item-vertical').forEach((option, index) => {
                option.classList.remove('selected');
                if (index + 1 === optionNumber) {
                    option.classList.add('selected');
                }
            });
        }

        // تابع ایجاد صفحه آزمون نوع 1 به صورت فول‌اسکرین با طرح جدید
        function createType1ExamPage() {
            // مخفی کردن container اصلی
            document.querySelector('.container').style.display = 'none';

            // ایجاد المان فول‌اسکرین
            const fullscreenExam = document.createElement('div');
            fullscreenExam.className = 'type1-exam-fullscreen';
            fullscreenExam.id = 'type1-exam-fullscreen';

            // ساختار صفحه آزمون نوع 1 فول‌اسکرین با طرح جدید
            fullscreenExam.innerHTML = `
    <div class="pdf-viewer-container">
    <div class="pdf-viewer">
        <img id="pdf-page-image" class="pdf-page-image" alt="صفحه PDF">
    </div>
</div>

        <div class="questions-sidebar">
    <div class="sidebar-header-improved">
        <div class="questions-header">
            <h4>سوالات آزمون</h4>
            <div class="questions-count">${examData.totalQuestions} سوال</div>
        </div>
    </div>
    
    <div class="questions-column" id="questions-column">
        <!-- سوالات اینجا ساخته می‌شوند -->
    </div>
    
    <div class="exam-actions-sidebar">
        <button class="btn btn-primary" id="start-exam-btn" onclick="startExamFullscreen()" style="width: 100%; margin-bottom: 10px;">
            <i class="fas fa-play"></i> شروع آزمون
        </button>
        <button class="btn btn-success" onclick="confirmFinishExam()" style="width: 100%; margin-top: 10px;">
            <i class="fas fa-flag-checkered"></i> پایان آزمون
        </button>
    </div>
</div>
        
        
    `;

            // اضافه کردن به body
            document.body.appendChild(fullscreenExam);

            // غیرفعال کردن اسکرول body
            document.body.style.overflow = 'hidden';

            // بارگذاری اولین صفحه PDF
            loadPDFPage(1);

            // ایجاد لیست سوالات به صورت ستونی
            createQuestionsColumn();

            // نمایش صفحه
            showNotification('آزمون نوع 1 در حالت فول‌اسکرین بارگذاری شد!', 'success');
        }

        // تابع ایجاد سوالات به صورت ستونی با گزینه‌های افقی
        function createQuestionsColumn() {
            const questionsColumn = document.getElementById('questions-column');
            questionsColumn.innerHTML = '';

            for (let i = 1; i <= examData.totalQuestions; i++) {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-item-column';
                questionItem.id = `question-item-${i}`;
                questionItem.onclick = () => selectQuestionColumn(i);

                // ایجاد گزینه‌ها به صورت افقی با مربع‌های کوچک
                let optionsHTML = '';
                const optionNumbers = ['۱', '۲', '۳', '۴', '۵'];

                for (let j = 0; j < examData.optionsCount; j++) {
                    optionsHTML += `
                <div class="option-square-small" 
                     onclick="event.stopPropagation(); selectOptionForQuestionColumn(${i}, ${j + 1})">
                    ${optionNumbers[j]}
                </div>
            `;
                }

                questionItem.innerHTML = `
            <div class="question-header-column">
                <div class="question-number-column">سوال ${i}</div>
                <div class="question-status-column" id="status-${i}">پاسخ داده نشده</div>
            </div>
            <div class="options-horizontal">
                ${optionsHTML}
            </div>
        `;

                questionsColumn.appendChild(questionItem);

                // اگر پاسخ قبلی وجود دارد، آن را نمایش بده
                if (examData.answers[i]) {
                    updateQuestionColumnDisplay(i, examData.answers[i]);
                }
            }
        }

        // تابع انتخاب سوال در ستون
        function selectQuestionColumn(questionNumber) {
            // هایلایت سوال انتخاب شده
            document.querySelectorAll('.question-item-column').forEach(item => {
                item.classList.remove('active');
            });

            const selectedItem = document.getElementById(`question-item-${questionNumber}`);
            if (selectedItem) {
                selectedItem.classList.add('active');

                // اسکرول به سوال انتخاب شده
                selectedItem.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }

        // تابع انتخاب گزینه برای سوال در ستون
        function selectOptionForQuestionColumn(questionNumber, optionNumber) {
            if (!examData.examStarted) {
                showNotification('لطفاً ابتدا آزمون را شروع کنید!', 'error');
                return;
            }

            // اگر گزینه قبلاً انتخاب شده بود، آن را حذف کن
            if (examData.answers[questionNumber] === optionNumber) {
                examData.answers[questionNumber] = null;
                showNotification(`پاسخ سوال ${questionNumber} حذف شد`, 'info');
            } else {
                // در غیر این صورت، گزینه جدید را انتخاب کن
                examData.answers[questionNumber] = optionNumber;
                showNotification(`پاسخ سوال ${questionNumber} ثبت شد`, 'success');
            }

            // به روزرسانی نمایش
            updateQuestionColumnDisplay(questionNumber, examData.answers[questionNumber]);
        }

        // تابع به روزرسانی نمایش سوال در ستون
        function updateQuestionColumnDisplay(questionNumber, optionNumber) {
            const questionItem = document.getElementById(`question-item-${questionNumber}`);
            if (!questionItem) return;

            const statusElement = document.getElementById(`status-${questionNumber}`);

            if (optionNumber) {
                // سوال پاسخ داده شده
                questionItem.classList.add('answered');
                questionItem.classList.remove('active');
                statusElement.innerHTML = `پاسخ: ${optionNumber}`;
                statusElement.style.color = 'var(--success-color)';
                statusElement.style.fontWeight = 'bold';
            } else {
                // سوال بدون پاسخ
                questionItem.classList.remove('answered');
                statusElement.innerHTML = 'پاسخ داده نشده';
                statusElement.style.color = 'var(--text-muted)';
                statusElement.style.fontWeight = 'normal';
            }

            // هایلایت گزینه انتخاب شده
            questionItem.querySelectorAll('.option-square-small').forEach((option, index) => {
                option.classList.remove('selected');
                if (index + 1 === optionNumber) {
                    option.classList.add('selected');
                }
            });
        }

        // تابع شروع آزمون برای طرح جدید
        function startExamFullscreen() {
            examData.examStarted = true;
            document.getElementById('start-exam-btn').style.display = 'none';
            startTimerFullscreen();
            showNotification('آزمون شروع شد! زمان در حال محاسبه است.');
        }

        // تابع تایمر برای طرح فول‌اسکرین
        function startTimerFullscreen() {
            if (examData.timerInterval) {
                clearInterval(examData.timerInterval);
            }

            const timerElement = document.getElementById('exam-timer-fullscreen');

            examData.timerInterval = setInterval(() => {
                examData.timeRemaining--;

                if (examData.timeRemaining <= 0) {
                    clearInterval(examData.timerInterval);
                    showTimeoutModal();
                    return;
                }

                timerElement.textContent = formatTime(examData.timeRemaining);
            }, 1000);
        }

        // تابع مخفی/نمایش تایمر در فول‌اسکرین
        function toggleTimerVisibilityFullscreen() {
            const timer = document.getElementById('exam-timer-fullscreen');
            if (timer.style.opacity === '0') {
                timer.style.opacity = '1';
            } else {
                timer.style.opacity = '0';
            }
        }

        // تابع اسکرول به سوال خاص
        function scrollToQuestionColumn(questionNumber) {
            selectQuestionColumn(questionNumber);
        }

        // تابع خروج از حالت فول‌اسکرین
        function exitFullscreen() {
            const fullscreenExam = document.getElementById('type1-exam-fullscreen');
            if (fullscreenExam) {
                document.body.removeChild(fullscreenExam);
                document.querySelector('.container').style.display = 'block';
                document.body.style.overflow = 'auto';

                // توقف تایمر
                if (examData.timerInterval) {
                    clearInterval(examData.timerInterval);
                }

                // برگشت به صفحه اصلی
                showPage('manual-exam');
            }
        }
        // تابع فرمت زمان (اگر قبلاً ندارید)
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // تابع تایمر برای طرح فول‌اسکرین با به‌روزرسانی هدر
        function startTimerFullscreen() {
            if (examData.timerInterval) {
                clearInterval(examData.timerInterval);
            }

            const timerElement = document.getElementById('exam-timer-fullscreen');
            const headerTimerElement = document.getElementById('exam-timer-header');

            examData.timerInterval = setInterval(() => {
                examData.timeRemaining--;

                if (examData.timeRemaining <= 0) {
                    clearInterval(examData.timerInterval);
                    showTimeoutModal();
                    return;
                }

                const timeString = formatTime(examData.timeRemaining);
                timerElement.textContent = timeString;
                headerTimerElement.textContent = timeString;
            }, 1000);
        }

        // تابع تغییر صفحه PDF
        async function changePDFPage(direction) {
            const newPage = examData.currentPDFPage + direction;
            const totalPages = pdfDocument ? pdfDocument.numPages : 1;

            if (newPage >= 1 && newPage <= totalPages) {
                await loadPDFPage(newPage);

                // نمایش نوتیفیکیشن برای تغییر صفحه (اختیاری)
                showNotification(`صفحه ${newPage} از ${totalPages}`, 'info');
            }
        }

        // تابع ایجاد صفحه آزمون نوع ۱ به صورت فول‌اسکرین با طرح جدید
        function createType1ExamPage() {
            // مخفی کردن container اصلی
            document.querySelector('.container').style.display = 'none';

            // ایجاد المان فول‌اسکرین
            const fullscreenExam = document.createElement('div');
            fullscreenExam.className = 'type1-exam-fullscreen';
            fullscreenExam.id = 'type1-exam-fullscreen';

            // ساختار ساده‌شده - فقط تصویر PDF
            fullscreenExam.innerHTML = `
        <div class="pdf-viewer-container">
            <div class="pdf-viewer">
                <img id="pdf-page-image" class="pdf-page-image" alt="صفحه PDF">
            </div>
        </div>

        <div class="questions-sidebar">
            <div class="sidebar-header-improved">
                <div class="exam-info-top">
                    <button class="btn btn-primary" id="start-exam-btn" onclick="startExamFullscreen()" style="width: 100%; margin-bottom: 10px;">
                        <i class="fas fa-play"></i> شروع آزمون
                    </button>
                    <div class="header-timer">
                        <i class="fas fa-clock"></i>
                        <span id="exam-timer-header">${formatTime(examData.timeRemaining)}</span>
                    </div>
                </div>
                <div class="questions-header">
                    <h4>سوالات آزمون</h4>
                    <div class="questions-count">${examData.totalQuestions} سوال</div>
                </div>
            </div>
            
            <div class="questions-column" id="questions-column">
                <!-- سوالات اینجا ساخته می‌شوند -->
            </div>
            
            <div class="exam-actions-sidebar">
                <button class="btn btn-success" onclick="confirmFinishExam()" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-flag-checkered"></i> پایان آزمون
                </button>
            </div>
        </div>
    `;

            // اضافه کردن به body
            document.body.appendChild(fullscreenExam);

            // غیرفعال کردن اسکرول body
            document.body.style.overflow = 'hidden';

            // بارگذاری اولین صفحه PDF
            loadPDFPage(1);

            // ایجاد لیست سوالات به صورت ستونی
            createQuestionsColumn();

            showNotification('آزمون نوع ۱ در حالت فول‌اسکرین بارگذاری شد!', 'success');
        }

        // تابع شروع آزمون برای طرح جدید
        function startExamFullscreen() {
            examData.examStarted = true;

            // مخفی کردن دکمه شروع آزمون
            const startBtn = document.getElementById('start-exam-btn');
            if (startBtn) {
                startBtn.style.display = 'none';
            }

            startTimerFullscreen();
            showNotification('آزمون شروع شد! زمان در حال محاسبه است.');
        }
    </script>
</body>

</html>